import{r as d,j as e}from"./react-vendor-DmEpS5Kz.js";import{c as ee,d as se}from"./index-D0qHnoCy.js";import{g as J}from"./services-data-Bkm-MtE8.js";import{g as K}from"./internalUrl-DfDVcRif.js";import"./vendor-dPMYpV4t.js";import"./axios-B9ygI19o.js";import"./opencc-C1Qz6KEM.js";import"./teamcraft-data-u2h6--oi.js";function te({text:s,onCopy:t}){const[n,r]=d.useState(!1),a=async c=>{c.stopPropagation();try{await navigator.clipboard.writeText(s),r(!0),t&&t(),setTimeout(()=>r(!1),1500)}catch(x){console.error("Failed to copy:",x)}};return e.jsx("button",{onClick:a,className:`
        p-0.5 rounded transition-all duration-200 flex-shrink-0
        ${n?"text-green-400":"text-gray-500 hover:text-ffxiv-gold hover:bg-purple-800/40"}
      `,title:n?"已複製":"複製名稱",children:n?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}):e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})})})}function re({node:s,itemName:t,priceInfo:n,onItemClick:r,isRoot:a=!1,isLoading:c=!1,isPriceQueried:x=!1,nodeRef:h,isHighlighted:m=!1,highlightMethod:o=null}){return e.jsxs("div",{ref:h,className:`
        flex flex-col items-center p-2 rounded-lg cursor-pointer transition-all duration-200
        ${a?"bg-gradient-to-br from-ffxiv-gold/20 to-yellow-500/10 border-2 border-ffxiv-gold/50 hover:border-ffxiv-gold min-w-[120px]":m?o==="craft"?"bg-gradient-to-br from-green-900/40 to-emerald-900/30 border-2 border-green-500/60 hover:border-green-400 min-w-[100px] shadow-[0_0_10px_rgba(34,197,94,0.2)]":"bg-gradient-to-br from-blue-900/40 to-cyan-900/30 border-2 border-blue-500/60 hover:border-blue-400 min-w-[100px] shadow-[0_0_10px_rgba(59,130,246,0.2)]":"bg-slate-800/60 border border-purple-500/30 hover:border-purple-400/60 hover:bg-slate-700/60 min-w-[100px]"}
      `,onClick:()=>r(s.itemId),title:`查看 ${t}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx(se,{itemId:s.itemId,alt:t,className:`${a?"w-12 h-12":"w-9 h-9"} object-contain rounded border border-purple-500/30`,priority:a}),!a&&s.amount>1&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-purple-900/90 text-ffxiv-gold text-xs font-bold px-1 py-0.5 rounded-full border border-purple-500/50 min-w-[18px] text-center leading-none",children:s.amount})]}),e.jsxs("div",{className:`mt-1.5 flex items-center gap-0.5 max-w-[100px] ${a?"max-w-[120px]":""}`,children:[e.jsx("p",{className:`${a?"text-xs font-semibold text-ffxiv-gold":"text-xs text-gray-300"} truncate flex-1`,title:t,children:t}),e.jsx(te,{text:t})]}),e.jsx("div",{className:`mt-1 text-center ${n?.worldName?"h-[32px]":"h-[20px]"} flex flex-col justify-center`,children:c?e.jsx("div",{className:"text-xs text-gray-500 animate-pulse",children:"載入中..."}):n?e.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[n.isHQ&&e.jsx("span",{className:"px-1 py-0.5 text-[10px] font-bold text-ffxiv-gold border border-ffxiv-gold/50 rounded bg-ffxiv-gold/10 cursor-default",children:"HQ"}),e.jsx("span",{className:`text-xs font-semibold ${n.isHQ?"text-yellow-400":"text-green-400"}`,children:n.price.toLocaleString()})]}),n.worldName&&e.jsx("span",{className:"text-[10px] text-gray-500 truncate max-w-[80px]",title:n.worldName,children:n.worldName})]}):x?e.jsx("span",{className:"text-xs text-gray-500",children:"無販售"}):e.jsx("div",{className:"text-xs text-gray-500 animate-pulse",children:"查詢中..."})})]})}function Y(s,t,n){const a=t[s.itemId]?.price??null,c=s.children&&s.children.length>0,x=n.has(s.itemId);if(!c)return x&&a===null?{cost:"N/A",method:"buy",breakdown:null}:{cost:a,method:"buy",breakdown:null};let h=!0;for(const g of s.children)if(!n.has(g.itemId)){h=!1;break}if(!h)return x&&a===null?{cost:"N/A",method:"buy",breakdown:null}:{cost:a,method:"buy",breakdown:null};let m=0,o=!1;const p=[];for(const g of s.children){const f=Y(g,t,n);if(f.cost==="N/A"){o=!0;break}else if(f.cost!==null&&typeof f.cost=="number"){const v=f.cost*g.amount;m+=v,p.push({itemId:g.itemId,amount:g.amount,unitCost:f.cost,totalCost:v,method:f.method})}else{o=!0;break}}return o?a!==null?{cost:a,method:"buy",breakdown:null}:x?{cost:"N/A",method:"buy",breakdown:null}:{cost:null,method:"buy",breakdown:null}:a===null?x?{cost:m,method:"craft",breakdown:p}:{cost:null,method:"buy",breakdown:null}:m<a?{cost:m,method:"craft",breakdown:p}:{cost:a,method:"buy",breakdown:null}}function G(s,t,n){if(!s.children||s.children.length===0)return null;let r=!0;for(const c of s.children)if(!n.has(c.itemId)){r=!1;break}if(!r)return null;let a=0;for(const c of s.children){const x=Y(c,t,n);if(x.cost==="N/A")return"N/A";if(x.cost!==null&&typeof x.cost=="number"){const h=x.cost*c.amount;a+=h}else return null}return a}function X(s,t,n,r=new Map){if(!(s.children&&s.children.length>0))return r.set(s.itemId,"buy"),r;let c=!0;for(const m of s.children)if(!n.has(m.itemId)){c=!1;break}if(!c)return r;const x=G(s,t,n);if(x===null||x==="N/A")return r.set(s.itemId,"buy"),r;const h=t[s.itemId]?.price??null;if(typeof x=="number"&&(h===null||x<h)){r.set(s.itemId,"craft");for(const m of s.children)X(m,t,n,r)}else r.set(s.itemId,"buy");return r}function ne({tree:s,itemPrices:t,queriedItemIds:n,itemNames:r}){const a=d.useMemo(()=>{if(!s||!s.children||s.children.length===0)return null;let p=!0;for(const j of s.children)if(!n.has(j.itemId)){p=!1;break}if(!p||!n.has(s.itemId))return null;const f=G(s,t,n);if(f===null)return null;const v=t[s.itemId]?.price??null,b=f,L=v===null,M=b==="N/A",I=typeof b=="number";if(M&&L)return{canCraft:!1,isInsufficientInfo:!0};if(M&&v!==null)return{rootPrice:v,cheapestRouteCost:"N/A",canCraft:!0,isMaterialsNA:!0,isCraftOnly:!1};if(I&&L)return{rootPrice:null,cheapestRouteCost:b,canCraft:!0,isCraftOnly:!0};if(I&&v!==null){const j=v-b;return{rootPrice:v,cheapestRouteCost:b,savings:j,canCraft:!0,isCraftOnly:!1}}return{canCraft:!1}},[s,t,n]);if(!a)return null;if(a.isInsufficientInfo)return e.jsx("div",{className:"px-4 py-2.5 rounded-lg text-sm font-medium bg-orange-900/50 border border-orange-500/40 text-orange-300 w-max min-w-max",children:e.jsx("div",{className:"flex flex-col items-center gap-1 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),e.jsx("span",{className:"font-bold flex-shrink-0",children:"該服缺乏關鍵素材且無成品購買"})]})})});if(!a.canCraft)return null;if(a.isMaterialsNA)return e.jsx("div",{className:"px-4 py-2.5 rounded-lg text-sm font-medium bg-blue-900/50 border border-blue-500/40 text-blue-300 w-max min-w-max",children:e.jsxs("div",{className:"flex flex-col items-center gap-1 whitespace-nowrap",children:[e.jsx("div",{className:"text-xs opacity-70 text-center whitespace-nowrap",children:"以最優路線計算（每項材料取買/製的較低價）"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm whitespace-nowrap",children:[e.jsx("span",{className:"flex-shrink-0",children:"最優製作: N/A"}),e.jsx("span",{className:"opacity-60 flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:["直購成品: ",a.rootPrice.toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsx("span",{className:"font-bold flex-shrink-0",children:"建議直購"})]})]})});if(a.isCraftOnly)return e.jsx("div",{className:"px-4 py-2.5 rounded-lg text-sm font-medium bg-green-900/50 border border-green-500/40 text-green-300 w-max min-w-max",children:e.jsxs("div",{className:"flex flex-col items-center gap-1 whitespace-nowrap",children:[e.jsx("div",{className:"text-xs opacity-70 text-center whitespace-nowrap",children:"以最優路線計算（每項材料取買/製的較低價）"}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsxs("span",{className:"font-bold flex-shrink-0",children:["自製最佳: ",a.cheapestRouteCost.toLocaleString()]})]})]})});const{rootPrice:c,cheapestRouteCost:x,savings:h}=a,m=h>0,o=Math.abs(h);return o<1?e.jsx("div",{className:"px-4 py-2.5 rounded-lg bg-gray-700/50 border border-gray-500/30 text-sm text-gray-400 w-max min-w-max",children:e.jsxs("div",{className:"flex flex-col items-center gap-1 whitespace-nowrap",children:[e.jsx("div",{className:"text-xs opacity-70 text-center whitespace-nowrap",children:"以最優路線計算（每項材料取買/製的較低價）"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm whitespace-nowrap",children:[e.jsxs("span",{className:"flex-shrink-0",children:["最優製作: ",x.toLocaleString()]}),e.jsx("span",{className:"opacity-60 flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:["直購成品: ",c.toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"font-bold flex-shrink-0",children:"價格相同"})]})]})}):e.jsx("div",{className:`
        px-4 py-2.5 rounded-lg text-sm font-medium w-max min-w-max
        ${m?"bg-green-900/50 border border-green-500/40 text-green-300":"bg-red-900/50 border border-red-500/40 text-red-300"}
      `,children:e.jsxs("div",{className:"flex flex-col items-center gap-1 whitespace-nowrap",children:[e.jsx("div",{className:"text-xs opacity-70 text-center whitespace-nowrap",children:"以最優路線計算（每項材料取買/製的較低價）"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm whitespace-nowrap",children:[e.jsxs("span",{className:"flex-shrink-0",children:["最優製作: ",x.toLocaleString()]}),e.jsx("span",{className:"opacity-60 flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:["直購成品: ",c.toLocaleString()]})]}),e.jsx("div",{className:"flex items-center gap-1.5 mt-0.5 whitespace-nowrap",children:m?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsxs("span",{className:"font-bold flex-shrink-0",children:["建議自製，省 ",o.toLocaleString()]})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsxs("span",{className:"font-bold flex-shrink-0",children:["建議直購，省 ",o.toLocaleString()]})]})})]})})}function ae({parentPrice:s,childrenTotalPrice:t,isReady:n,amount:r=1}){if(!n)return null;const a=s!=null,c=t!==null&&t!=="N/A"&&typeof t=="number",x=t==="N/A",h=s==null;if(x&&h)return e.jsx("div",{className:"px-2 py-1 rounded-lg bg-gray-700/50 border border-gray-500/30 text-xs text-gray-400",children:"資訊不足"});if(x&&a)return e.jsx("div",{className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-900/50 border border-blue-500/40 text-blue-300 w-max min-w-max",children:e.jsxs("div",{className:"flex flex-col items-center gap-0.5 whitespace-nowrap",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 whitespace-nowrap",children:[e.jsx("span",{className:"flex-shrink-0",children:"材料: N/A"}),e.jsx("span",{className:"flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:[r>1?`${r}個`:"","成品: ",s.toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsx("span",{className:"font-bold flex-shrink-0",children:"建議直購"})]})]})});if(c&&h)return e.jsx("div",{className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-green-900/50 border border-green-500/40 text-green-300 w-max min-w-max",children:e.jsxs("div",{className:"flex flex-col items-center gap-0.5 whitespace-nowrap",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 whitespace-nowrap",children:[e.jsxs("span",{className:"flex-shrink-0",children:["材料: ",t.toLocaleString()]}),e.jsx("span",{className:"flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:[r>1?`${r}個`:"","成品: N/A"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"font-bold flex-shrink-0",children:"建議自製"})]})]})});if(!c||!a)return null;const m=s-t,o=m>0,p=Math.abs(m);return p<1?e.jsx("div",{className:"px-3 py-1.5 rounded-lg bg-gray-700/50 border border-gray-500/30 text-xs text-gray-400 w-max min-w-max",children:e.jsxs("div",{className:"flex flex-col items-center gap-0.5 whitespace-nowrap",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 whitespace-nowrap",children:[e.jsxs("span",{className:"flex-shrink-0",children:["材料: ",t.toLocaleString()]}),e.jsx("span",{className:"flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:[r>1?`${r}個`:"","成品: ",s.toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 whitespace-nowrap",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"font-bold flex-shrink-0",children:"價格相同"})]})]})}):e.jsx("div",{className:`
        px-3 py-1.5 rounded-lg text-xs font-medium w-max min-w-max
        ${o?"bg-green-900/50 border border-green-500/40 text-green-300":"bg-red-900/50 border border-red-500/40 text-red-300"}
      `,children:e.jsxs("div",{className:"flex flex-col items-center gap-0.5 whitespace-nowrap",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 whitespace-nowrap",children:[e.jsxs("span",{className:"flex-shrink-0",children:["材料: ",t.toLocaleString()]}),e.jsx("span",{className:"flex-shrink-0",children:"vs"}),e.jsxs("span",{className:"flex-shrink-0",children:[r>1?`${r}個`:"","成品: ",s.toLocaleString()]})]}),e.jsx("div",{className:"flex items-center gap-1.5 whitespace-nowrap",children:o?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsxs("span",{className:"font-bold flex-shrink-0",children:["自製省 ",p.toLocaleString()]})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsxs("span",{className:"font-bold flex-shrink-0",children:["直購省 ",p.toLocaleString()]})]})})]})})}function Z({node:s,itemNames:t,itemPrices:n,queriedItemIds:r,onItemClick:a,isRoot:c=!1,isLoading:x=!1,optimalPathMap:h=null,isCraftingCheaper:m=!1}){const o=d.useRef(null),[p,g]=d.useState({left:0,width:0}),f=s.children&&s.children.length>0,v=t[s.itemId]||`物品 ${s.itemId}`,b=n[s.itemId],L=r.has(s.itemId),M=h?.get(s.itemId),I=m&&M!==void 0,j=I&&M==="craft",N=d.useMemo(()=>{if(!f)return null;let w=!0;for(const C of s.children)if(!r.has(C.itemId)){w=!1;break}if(!w)return null;let u=0,S=!1;for(const C of s.children){const z=n[C.itemId];z&&z.price!==void 0?u+=z.price*C.amount:S=!0}return S?"N/A":u},[f,s.children,n,r]),W=d.useMemo(()=>{if(!f)return!1;let w=!0;for(const S of s.children)if(!r.has(S.itemId)){w=!1;break}return!w||N===null?!1:r.has(s.itemId)},[f,s.children,b,N,r]),_=d.useCallback(()=>{if(f&&s.children.length>1&&o.current){const w=o.current,u=w.children;if(u.length>=2){const S=u[0],C=u[u.length-1],z=w.getBoundingClientRect(),A=S.getBoundingClientRect(),T=C.getBoundingClientRect(),D=A.left+A.width/2-z.left,Q=T.left+T.width/2-z.left;Q-D>0&&g({left:D,width:Q-D})}}},[f,s.children?.length]);d.useEffect(()=>{const w=setTimeout(_,50);let u;return o.current&&typeof ResizeObserver<"u"&&(u=new ResizeObserver(()=>{_()}),u.observe(o.current)),()=>{clearTimeout(w),u&&u.disconnect()}},[_,t,n]);const y=j?"bg-green-400":"bg-purple-500/50",P=j?"w-0.5":"w-px",R=j?"shadow-[0_0_6px_rgba(74,222,128,0.6)]":"";return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(re,{node:s,itemName:v,priceInfo:b,onItemClick:a,isRoot:c,isLoading:x,isPriceQueried:L,isHighlighted:I&&!c,highlightMethod:M}),f&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`${P} h-4 ${y} ${R}`}),c?e.jsx(ne,{tree:s,itemPrices:n,queriedItemIds:r,itemNames:t}):e.jsx(ae,{parentPrice:b?.price?b.price*s.amount:null,childrenTotalPrice:N,isReady:W,amount:s.amount}),e.jsx("div",{className:`${P} h-4 ${y} ${R}`}),e.jsxs("div",{className:"relative",children:[s.children.length>1&&p.width>0&&e.jsx("div",{className:`absolute top-0 ${j?"h-0.5":"h-px"} ${y} ${R}`,style:{left:`${p.left}px`,width:`${p.width}px`}}),e.jsx("div",{ref:o,className:"flex gap-3 items-start",children:s.children.map((w,u)=>e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`${j?"w-0.5 bg-green-400 shadow-[0_0_6px_rgba(74,222,128,0.6)]":"w-px bg-purple-500/50"} h-4`}),e.jsx(Z,{node:w,itemNames:t,itemPrices:n,queriedItemIds:r,onItemClick:a,isLoading:x,optimalPathMap:h,isCraftingCheaper:m&&j})]},`${w.itemId}-${u}`))})]})]})]})}function fe({tree:s,selectedServerOption:t,selectedWorld:n,worlds:r={},onItemSelect:a,excludeCrystals:c=!0,onExcludeCrystalsChange:x}){const[h,m]=d.useState({}),[o,p]=d.useState({}),[g,f]=d.useState(new Set),[v,b]=d.useState(!0),[L,M]=d.useState(!0),[I,j]=d.useState(null),N=d.useRef(null),[W,_]=d.useState(!1),[y,P]=d.useState(!1),[R,w]=d.useState(0),[u,S]=d.useState(0),C=d.useMemo(()=>{if(!t)return!1;const l=n?.section;return t===l},[t,n]),z=d.useMemo(()=>{if(!t)return null;const l=n?.section;if(t===l)return`${l}（全服搜尋）`;if(typeof t=="number"||!isNaN(Number(t))){const i=typeof t=="number"?t:Number(t);return r[i]||`伺服器 ${t}`}else return t},[t,n,r]),A=d.useCallback((l,i=new Set)=>(l&&(i.add(l.itemId),l.children&&l.children.forEach(k=>A(k,i))),i),[]);d.useEffect(()=>{if(!s)return;const l=Array.from(A(s));b(!0),Promise.all(l.map(async i=>{const k=await J(i);return{id:i,name:k?.name||`物品 ${i}`}})).then(i=>{const k={};i.forEach(({id:$,name:H})=>{k[$]=H}),m(k),b(!1)}).catch(i=>{console.error("Failed to load item names:",i),j("載入物品名稱失敗"),b(!1)})},[s,A]),d.useEffect(()=>{const l=r&&Object.keys(r).length>0;if(!s||!t||!l)return;const i=A(s),k=Array.from(i),$=[...new Set(k)];M(!0),f(new Set),p({}),j(null),(async()=>{try{const E=[];for(let B=0;B<$.length;B+=100)E.push($.slice(B,B+100));for(const B of E){const q=await ee(t,B,r);p(F=>({...F,...q})),f(F=>new Set([...F,...B])),E.length>1&&await new Promise(F=>setTimeout(F,100))}}catch(E){console.error("Failed to fetch prices:",E),f(new Set($))}M(!1)})()},[s,t,r,A]);const T=d.useCallback(l=>{if(a)J(l).then(i=>{if(i)a(i);else{const k=`${window.location.origin}${K(`/item/${l}`)}`;window.open(k,"_blank","noopener,noreferrer")}});else{const i=`${window.location.origin}${K(`/item/${l}`)}`;window.open(i,"_blank","noopener,noreferrer")}},[a]);d.useEffect(()=>{const l=()=>{if(N.current){const $=N.current,H=$.scrollWidth>$.clientWidth;_(H)}};l();const i=new ResizeObserver(l);N.current&&i.observe(N.current);const k=setInterval(l,500);return()=>{i.disconnect(),clearInterval(k)}},[s,h,o]);const D=d.useCallback(l=>{if(!N.current||!W)return;const i=l.target;i.closest("button, a, [data-item-id], img, svg, path")||i.tagName==="BUTTON"||i.tagName==="A"||i.tagName==="IMG"||i.tagName==="SVG"||i.tagName==="PATH"||i.closest(".cursor-pointer")||(P(!0),w(l.clientX),S(N.current.scrollLeft),l.preventDefault(),l.stopPropagation())},[W]),Q=d.useCallback(l=>{if(!y||!N.current)return;const i=l.clientX-R;N.current.scrollLeft=u-i,l.preventDefault(),l.stopPropagation()},[y,R,u]),V=d.useCallback(()=>{P(!1)},[]);d.useEffect(()=>{if(y)return document.addEventListener("mousemove",Q),document.addEventListener("mouseup",V),document.body.style.cursor="grabbing",document.body.style.userSelect="none",()=>{document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",V),document.body.style.cursor="",document.body.style.userSelect=""}},[y,Q,V]);const{optimalPathMap:O,isCraftingCheaper:U}=d.useMemo(()=>{if(!s||L||Object.keys(o).length===0)return{optimalPathMap:null,isCraftingCheaper:!1};if(!s.children||s.children.length===0)return{optimalPathMap:null,isCraftingCheaper:!1};for(const H of s.children)if(!g.has(H.itemId))return{optimalPathMap:null,isCraftingCheaper:!1};const l=G(s,o,g);if(l===null)return{optimalPathMap:null,isCraftingCheaper:!1};if(l==="N/A")return{optimalPathMap:null,isCraftingCheaper:!1};const i=o[s.itemId]?.price??null;return i===null?typeof l=="number"?{optimalPathMap:X(s,o,g),isCraftingCheaper:!0}:{optimalPathMap:null,isCraftingCheaper:!1}:typeof l!="number"?{optimalPathMap:null,isCraftingCheaper:!1}:l<i?{optimalPathMap:X(s,o,g),isCraftingCheaper:!0}:{optimalPathMap:null,isCraftingCheaper:!1}},[s,o,g,L]);return s?e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold text-ffxiv-gold flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})}),"製作價格樹"]}),t&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-md bg-purple-900/40 border border-purple-500/30 text-xs",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 text-purple-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"})}),e.jsx("span",{className:"text-purple-300",children:z}),e.jsx("span",{className:"text-gray-500",children:"·"}),e.jsx("span",{className:"text-gray-400",children:C?"最低價":"平均價格"})]}),x&&e.jsxs("div",{className:"relative flex items-center gap-2 px-2 py-1 rounded-md bg-slate-800/60 border border-slate-600/40 text-xs group overflow-hidden ",onClick:l=>l.stopPropagation(),style:c?{}:{boxShadow:"0 0 8px rgba(147, 51, 234, 0.3)",animation:"crystalShimmer 3s ease-in-out infinite"},children:[!c&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-purple-400/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-in-out pointer-events-none"}),e.jsx("span",{className:"text-gray-400 cursor-help relative z-10",children:"顯示水晶"}),e.jsx("button",{onClick:l=>{l.stopPropagation(),x(!c)},className:`
                  relative inline-flex h-5 w-9 items-center rounded-full transition-all duration-200 ease-in-out z-10
                  ${c?"bg-purple-600/50":"bg-ffxiv-gold/70 shadow-[0_0_6px_rgba(212,175,55,0.4)]"}
                  focus:outline-none focus:ring-2 focus:ring-ffxiv-gold focus:ring-offset-2 focus:ring-offset-slate-800
                `,role:"switch","aria-checked":!c,"aria-label":c?"顯示水晶物品":"隱藏水晶物品",children:e.jsx("span",{className:`
                    inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ease-in-out
                    ${c?"translate-x-1":"translate-x-5"}
                    ${c?"":"shadow-[0_0_4px_rgba(255,255,255,0.5)]"}
                  `})}),e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-slate-900/95 text-white text-xs rounded shadow-lg border border-purple-500/50 whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200 z-[9999]",children:["提供給大量製作的匠人更精確定位價格",e.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-purple-500/50"})]})]}),e.jsx("style",{children:`
            @keyframes crystalShimmer {
              0%, 100% {
                box-shadow: 0 0 8px rgba(147, 51, 234, 0.3);
              }
              50% {
                box-shadow: 0 0 12px rgba(147, 51, 234, 0.5), 0 0 20px rgba(147, 51, 234, 0.2);
              }
            }
          `})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[!L&&s&&o[s.itemId]&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-md bg-slate-800/60 border border-slate-600/40 text-xs",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5 text-cyan-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"})}),e.jsx("span",{className:"text-gray-400",children:"日均銷量:"}),o[s.itemId].velocityWorld!==void 0&&e.jsxs("span",{className:"text-cyan-300",title:"單服日均銷量",children:["單服 ",o[s.itemId].velocityWorld.toFixed(1)]}),o[s.itemId].velocityWorld!==void 0&&o[s.itemId].velocityDc!==void 0&&e.jsx("span",{className:"text-gray-500",children:"/"}),o[s.itemId].velocityDc!==void 0&&e.jsxs("span",{className:"text-emerald-300",title:"全服日均銷量",children:["全服 ",o[s.itemId].velocityDc.toFixed(1)]})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-400",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-ffxiv-gold"}),"載入價格中..."]})]})]}),I&&e.jsx("div",{className:"mb-4 p-2 bg-red-900/30 border border-red-500/30 rounded text-sm text-red-400",children:I}),e.jsx("div",{ref:N,className:`overflow-x-auto pb-2 relative ${W&&!y?"cursor-grab":""} ${y?"cursor-grabbing":""}`,onMouseDown:D,onMouseLeave:()=>{y&&P(!1)},children:e.jsx("div",{className:"flex justify-center min-w-min py-2",children:e.jsx(Z,{node:s,itemNames:h,itemPrices:o,queriedItemIds:g,onItemClick:T,isRoot:!0,isLoading:v,optimalPathMap:O,isCraftingCheaper:U})})}),e.jsxs("div",{className:"mt-4 pt-3 border-t border-purple-500/20 flex flex-wrap gap-4 text-xs text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-gradient-to-br from-ffxiv-gold/20 to-yellow-500/10 border border-ffxiv-gold/50"}),e.jsx("span",{children:"成品"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-slate-800/60 border border-purple-500/30"}),e.jsx("span",{children:"材料"})]}),U&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-gradient-to-br from-green-900/40 to-emerald-900/30 border-2 border-green-500/60"}),e.jsx("span",{className:"text-green-400",children:"最優路線(製作)"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-gradient-to-br from-blue-900/40 to-cyan-900/30 border-2 border-blue-500/60"}),e.jsx("span",{className:"text-blue-400",children:"最優路線(購買)"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"價格"}),e.jsxs("span",{children:["= NQ",C?"最低價":"平均價"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"px-1 py-0.5 text-[10px] font-bold text-ffxiv-gold border border-ffxiv-gold/50 rounded bg-ffxiv-gold/10 cursor-default",children:"HQ"}),e.jsx("span",{className:"text-yellow-400 font-semibold",children:"價格"}),e.jsxs("span",{children:["= HQ",C?"最低價":"平均價"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})}),e.jsx("span",{children:"= 複製名稱"})]})]})]}):e.jsx("div",{className:"p-4 text-center text-gray-400",children:"無製作配方"})}export{fe as default};

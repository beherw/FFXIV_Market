import{_ as ht,g as Mt,T as qr,a as Rr,S as Er,I as Mr,b as Lr}from"./index-BkJKGLRc.js";import{u as Dr,b as Ar,a as $r,r as l,d as Qe,j as t}from"./react-vendor-DmEpS5Kz.js";import{l as Wt,g as Ke,b as Br}from"./services-data-CB3AkOTv.js";import{t as Tr}from"./tw-job-abbr-xwaoke-z.js";import{a as gt}from"./teamcraft-data-u2h6--oi.js";import"./axios-B9ygI19o.js";import"./vendor-dPMYpV4t.js";import"./opencc-C1Qz6KEM.js";const _r={1:{tw:"格鬥武器"},2:{tw:"單手劍"},3:{tw:"大斧"},4:{tw:"弓"},5:{tw:"長槍"},6:{tw:"單手咒杖"},7:{tw:"雙手咒杖"},8:{tw:"單手幻杖"},9:{tw:"雙手幻杖"},10:{tw:"魔導書"},11:{tw:"盾"},12:{tw:"木工工具（主工具）"},13:{tw:"木工工具（副工具）"},14:{tw:"鍛造工具（主工具）"},15:{tw:"鍛造工具（副工具）"},16:{tw:"甲冑工具（主工具）"},17:{tw:"甲冑工具（副工具）"},18:{tw:"金工工具（主工具）"},19:{tw:"金工工具（副工具）"},20:{tw:"皮革工具（主工具）"},21:{tw:"皮革工具（副工具）"},22:{tw:"裁縫工具（主工具）"},23:{tw:"裁縫工具（副工具）"},24:{tw:"鍊金工具（主工具）"},25:{tw:"鍊金工具（副工具）"},26:{tw:"烹調工具（主工具）"},27:{tw:"烹調工具（副工具）"},28:{tw:"採掘工具（主工具）"},29:{tw:"採掘工具（副工具）"},30:{tw:"園藝工具（主工具）"},31:{tw:"園藝工具（副工具）"},32:{tw:"捕魚用具（主工具）"},33:{tw:"釣餌"},34:{tw:"頭部防具"},35:{tw:"身體防具"},36:{tw:"腿部防具"},37:{tw:"手部防具"},38:{tw:"腳部防具"},39:{tw:"停止流通道具"},40:{tw:"項鍊"},41:{tw:"耳飾"},42:{tw:"手鐲"},43:{tw:"戒指"},44:{tw:"藥品"},45:{tw:"食材"},46:{tw:"食品"},47:{tw:"水產品"},48:{tw:"石材"},49:{tw:"金屬"},50:{tw:"木材"},51:{tw:"布料"},52:{tw:"皮革"},53:{tw:"骨材"},54:{tw:"鍊金原料"},55:{tw:"染料"},56:{tw:"組件"},57:{tw:"傢俱"},58:{tw:"魔晶石"},59:{tw:"水晶"},60:{tw:"觸媒"},61:{tw:"雜貨"},62:{tw:"靈魂水晶"},63:{tw:"其他"},64:{tw:"房產證書"},65:{tw:"房頂"},66:{tw:"外牆"},67:{tw:"窗戶"},68:{tw:"房門"},69:{tw:"房頂裝飾"},70:{tw:"外牆裝飾"},71:{tw:"門牌"},72:{tw:"院牆"},73:{tw:"內牆"},74:{tw:"地板"},75:{tw:"屋頂照明"},76:{tw:"庭具"},77:{tw:"桌台"},78:{tw:"桌上"},79:{tw:"壁掛"},80:{tw:"地毯"},81:{tw:"寵物"},82:{tw:"栽培用品"},83:{tw:"半魔晶石"},84:{tw:"雙劍"},85:{tw:"雜貨（季節活動）"},86:{tw:"九宮幻卡"},87:{tw:"雙手劍"},88:{tw:"火槍"},89:{tw:"天球儀"},90:{tw:"飛空艇組件（船體）"},91:{tw:"飛空艇組件（艤裝）"},92:{tw:"飛空艇組件（船尾）"},93:{tw:"飛空艇組件（船首）"},94:{tw:"管弦樂琴樂譜"},95:{tw:"繪畫作品"},96:{tw:"武士刀"},97:{tw:"刺劍"},98:{tw:"魔導書（學者專用）"},99:{tw:"捕魚用具（副工具）"},100:{tw:"貨幣"},101:{tw:"潛水艇組件（船體）"},102:{tw:"潛水艇組件（船尾）"},103:{tw:"潛水艇組件（船首）"},104:{tw:"潛水艇組件（艦橋）"},105:{tw:"青魔杖"},106:{tw:"槍刃"},107:{tw:"投擲武器"},108:{tw:"雙手鐮刀"},109:{tw:"賢具"},110:{tw:"二刀流武器"},111:{tw:"筆"},112:{tw:"套裝"}};function Kr({addToast:K,removeToast:Ot,toasts:Qt,datacenters:Kt,worlds:mt,selectedWorld:O,onWorldChange:Zt,selectedServerOption:H,onServerOptionChange:Xt,serverOptions:Yt,isServerDataLoaded:Ue,onItemSelect:pt,onSearch:er,searchText:tr,setSearchText:rt,isSearching:Z,onTaxRatesClick:rr,isTaxRatesModalOpen:nr,setIsTaxRatesModalOpen:sr,taxRates:lr,isLoadingTaxRates:ar}){const xt=Dr(),[Lt]=Ar(),Ze=$r(),[Y,bt]=l.useState("filter"),wt=!0,[Dt,ir]=l.useState(""),[ie,ee]=l.useState([]),[ue,fe]=l.useState([]),[Ce,pe]=l.useState(!1),vt=l.useRef(!1),yt=l.useRef(""),[or,Me]=l.useState({}),[cr,Le]=l.useState({}),[dr,De]=l.useState({}),[ur,Ae]=l.useState({}),[It,xe]=l.useState({}),[Pe,X]=l.useState(!1),[At,St]=l.useState(null),[Nt,Fr]=l.useState(!1),[Je,$e]=l.useState(null),nt=500,[fr,Vr]=l.useState(!0),[F,$t]=l.useState([]),[te,Bt]=l.useState([]),[z,U]=l.useState(!1),[Be,hr]=l.useState(new Set),[be,Ge]=l.useState(1),[we,He]=l.useState(999),[gr,Tt]=l.useState(!1),[mr,_t]=l.useState(!1),[We,jt]=l.useState(""),[ke,pr]=l.useState(!0),[Te,Ct]=l.useState(""),Pt=[62],[L,he]=l.useState(1),[ve,Ft]=l.useState(50),[xr,Xe]=l.useState(!1),Oe=l.useRef(null),_e=l.useCallback(e=>{hr(r=>new Set(r).add(e))},[]),W=l.useRef(null),J=l.useRef(0),qe=l.useRef(!1),[st,Re]=l.useState(!1),g=l.useRef(0);l.useRef(0);const[Ye,et]=l.useState(!1),kt=l.useRef(null),lt=l.useRef(null),at=l.useCallback(async()=>{if(lt.current)return lt.current;const e=await ht(()=>import("./ilvls-Bj6OKdVo.js"),[]);return lt.current=e.default,lt.current},[]),it=l.useRef(null),[ye,br]=l.useState(null),[ot,qt]=l.useState([]),Vt=l.useCallback(async()=>{if(it.current)return it.current;const e=await ht(()=>import("./rarities-CrVnX0d9.js"),[]);return it.current=e.default,it.current},[]);l.useEffect(()=>{Vt().then(e=>{br(e)})},[Vt]),l.useEffect(()=>{he(1)},[ot]),l.useEffect(()=>{if(ie.length>0||ue.length>0){const r=Math.ceil((Ce?ue:ie).length/ve);r>0&&L>r&&he(1)}},[ie.length,ue.length,Ce,ve,L]);const ct=l.useRef(null),dt=l.useCallback(async()=>{if(ct.current)return ct.current;const e=await ht(()=>import("./equipment-sIOEhpr0.js"),[]);return ct.current=e.default,ct.current},[]),ut=l.useRef(null),zt=l.useCallback(async()=>{if(ut.current)return ut.current;const e=await ht(()=>import("./ui-categories-B7UiuPPW.js"),[]);return ut.current=e.default,ut.current},[]),Rt=l.useCallback(e=>({1:"GLA",2:"PGL",3:"MRD",4:"LNC",5:"ARC",6:"CNJ",7:"THM",8:"CRP",9:"BSM",10:"ARM",11:"GSM",12:"LTW",13:"WVR",14:"ALC",15:"CUL",16:"MIN",17:"BTN",18:"FSH",19:"PLD",20:"MNK",21:"WAR",22:"DRG",23:"BRD",24:"WHM",25:"BLM",26:"ACN",27:"SMN",28:"SCH",29:"ROG",30:"NIN",31:"MCH",32:"DRK",33:"AST",34:"SAM",35:"RDM",36:"BLU",37:"GNB",38:"DNC",39:"RPR",40:"SGE",41:"VPR",42:"PCT"})[e],[]);l.useCallback(async(e=null)=>{{K("批量搜索功能暂时不可用，敬请期待","info");return}},[Dt,O,H,K,Ye,fr]),l.useEffect(()=>{if(!Ue)return;const e=`${Ze.pathname}?${Ze.search}`;if(yt.current===e)return;if(Ze.pathname!=="/advanced-search"){yt.current=e;return}const r=Lt.get("q");r&&r.trim()!==""?(Y==="batch"&&bt("filter"),vt.current=!1):(vt.current&&ie.length>0&&(ee([]),Me({}),Le({}),De({}),Ae({}),xe({}),he(1)),vt.current=!1),yt.current=e},[Ze.pathname,Ze.search,Lt,Ue,Dt,Y,ie.length,Nt,z,Z]),l.useEffect(()=>{Y==="batch"&&bt("filter")},[Y]),l.useEffect(()=>{if((Pe||z||st)&&((Y==="filter"&&Ce?ue:ie).length>=50||ie.length>=50||ue.length>=50))Oe.current||(Oe.current=Date.now()),Xe(!0);else if(Oe.current){const k=Date.now()-Oe.current,u=Math.max(0,1e3-k);if(u>0){const M=setTimeout(()=>{Xe(!1),Oe.current=null},u);return()=>clearTimeout(M)}else Xe(!1),Oe.current=null}else Xe(!1)},[Pe,z,st,Ce,ie.length,ue.length,Y]);const{craftingJobs:wr,gatheringJobs:vr,battleJobsByRole:ge}=l.useMemo(()=>{const e=new Set([1,2,3,4,5,6,7,26,29]),r={19:"paladin",20:"monk",21:"warrior",22:"dragoon",23:"bard",24:"whitemage",25:"blackmage",27:"summoner",28:"scholar",30:"ninja",31:"machinist",32:"darkknight",33:"astrologian",34:"samurai",35:"redmage",36:"bluemage",37:"gunbreaker",38:"dancer",39:"reaper",40:"sage",41:"viper",42:"pictomancer",8:"carpenter",9:"blacksmith",10:"armorer",11:"goldsmith",12:"leatherworker",13:"weaver",14:"alchemist",15:"culinarian",16:"miner",17:"botanist",18:"fisher"},k={19:"tank",21:"tank",32:"tank",37:"tank",24:"healer",28:"healer",33:"healer",40:"healer",20:"melee",22:"melee",30:"melee",34:"melee",39:"melee",41:"melee",23:"ranged",31:"ranged",38:"ranged",25:"caster",27:"caster",35:"caster",36:"caster",42:"caster"},u=[],M=[],q={tank:[],healer:[],melee:[],ranged:[],caster:[]};return Object.entries(Tr).forEach(([S,v])=>{const R=parseInt(S,10);if(e.has(R))return;const o=r[R];if(!o)return;const s={id:R,name:v.tw,iconUrl:`https://xivapi.com/cj/companion/${o}.png`};if(R>=8&&R<=15)u.push(s);else if(R>=16&&R<=18)M.push(s);else if(R>=19&&R<=42){const c=k[R];c&&q[c]&&q[c].push(s)}}),u.sort((S,v)=>S.id-v.id),M.sort((S,v)=>S.id-v.id),Object.keys(q).forEach(S=>{q[S].sort((v,R)=>v.id-R.id)}),{craftingJobs:u,gatheringJobs:M,battleJobsByRole:q}},[]),yr=new Set([1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111]),Ir=new Set([12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,99]),Sr={19:[2],20:[1],21:[3],22:[5],23:[4],24:[8,9],25:[6,7],27:[10],28:[10,98],30:[84],31:[88],32:[2,87],33:[89],34:[96],35:[97],36:[105],37:[106],38:[107],39:[108],40:[109],41:[110],42:[111]},Nr={8:12,9:14,10:16,11:18,12:20,13:22,14:24,15:26},jr={8:13,9:15,10:17,11:19,12:21,13:23,14:25,15:27},Cr={19:11},Pr={16:28,17:30,18:32},kr={16:29,17:31,18:99},Ut={主武器:[1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111,12,14,16,18,20,22,24,26,28,30,32],副手武器:[11,13,15,17,19,21,23,25,27,29,31,33,99]},Jt=new Set([34,35,36,37,38,40,41,42,43,62]),Fe=l.useMemo(()=>{const e=Object.entries(_r).map(([s,c])=>({id:parseInt(s,10),name:c.tw})).filter(s=>!yr.has(s.id)&&!Ir.has(s.id)&&!Pt.includes(s.id)),r=e.filter(s=>Jt.has(s.id)),k=e.filter(s=>!Jt.has(s.id)&&s.id!==11),u=[34,35,37,36,38,41,40,42,43,62];r.sort((s,c)=>{const n=u.indexOf(s.id),a=u.indexOf(c.id);return n!==-1&&a!==-1?n-a:n!==-1?-1:a!==-1?1:s.id-c.id}),k.sort((s,c)=>s.id===39?1:c.id===39?-1:s.id-c.id);const M=[{id:"main_weapon",name:"主手",isGeneric:!0},{id:"offhand_weapon",name:"副手",isGeneric:!0}],q=[34,35,37,36,38],S=[41,40,42,43],v=r.filter(s=>q.includes(s.id)),R=r.filter(s=>S.includes(s.id)),o=r.filter(s=>!q.includes(s.id)&&!S.includes(s.id));return{weapons:M,armor:v,accessories:R,otherEquipment:o,miscellaneous:k}},[]),$=l.useMemo(()=>{if(!Te.trim())return Fe;const e=Te.toLowerCase().trim(),r=k=>k.name.toLowerCase().includes(e);return{weapons:Fe.weapons.filter(r),armor:Fe.armor.filter(r),accessories:Fe.accessories.filter(r),otherEquipment:Fe.otherEquipment.filter(r),miscellaneous:Fe.miscellaneous.filter(r)}},[Fe,Te]),Ve=l.useCallback(e=>{$t(r=>r.includes(e)?r.filter(k=>k!==e):[...r,e])},[]),Et=l.useCallback(e=>{Bt(r=>r.includes(e)?r.filter(k=>k!==e):[...r,e]),Ct(""),setTimeout(()=>{kt.current&&kt.current.focus()},0)},[]),Ee=l.useCallback(e=>{he(e)},[]),Gt=l.useCallback(async(e=!1)=>{if(F.length===0&&te.length===0)return K("請至少選擇一個職業或分類","warning"),null;if(!O||!H)return K("請選擇伺服器","warning"),null;let r=new Set;const k=F.filter(o=>o>=8&&o<=18),u=F.filter(o=>o>=1&&o<=7||o>=19&&o<=42);if(k.length>0){const{recipes:o}=await Wt();k.forEach(n=>{o.forEach(a=>{a.job===n&&a.result&&r.add(a.result)})});const s=await dt(),c=k.map(n=>Rt(n)).filter(n=>n);Object.entries(s).forEach(([n,a])=>{a.jobs&&Array.isArray(a.jobs)&&c.some(D=>a.jobs.includes(D))&&r.add(parseInt(n,10))})}if(u.length>0){const o=await dt(),s=u.map(c=>Rt(c)).filter(c=>c);Object.entries(o).forEach(([c,n])=>{n.jobs&&Array.isArray(n.jobs)&&s.some(j=>n.jobs.includes(j))&&r.add(parseInt(c,10))})}if(te.length>0){const o=await zt();let s=new Set;if(te.forEach(c=>{c==="main_weapon"?F.length>0?F.forEach(n=>{const a=Sr[n];a&&a.forEach(re=>s.add(re));const j=Nr[n];j&&s.add(j);const D=Pr[n];D&&s.add(D)}):Ut.主武器.forEach(n=>s.add(n)):c==="offhand_weapon"?F.length>0?F.forEach(n=>{const a=Cr[n];a&&s.add(a);const j=jr[n];j&&s.add(j);const D=kr[n];D&&s.add(D)}):Ut.副手武器.forEach(n=>s.add(n)):s.add(parseInt(c,10))}),r.size===0&&F.length===0&&Object.keys(gt).forEach(c=>{r.add(parseInt(c,10))}),s.size>0){const c=new Set;r.forEach(n=>{const a=o[n.toString()];Pt.includes(a)||a&&s.has(a)&&c.add(n)}),r=c}else{const c=new Set;r.forEach(n=>{const a=o[n.toString()];Pt.includes(a)||c.add(n)}),r=c}}if(be>1||we<999){const o=await dt(),s=new Set;r.forEach(c=>{const n=o[c.toString()];!n||n.level===void 0||n.level===null?be===1&&we===999&&s.add(c):n.level>=be&&n.level<=we&&s.add(c)}),r=s}if(We.trim()){const o=new Set,s=We.trim().split(/\s+/).filter(n=>n),c=(n,a)=>{const j=Array.from(n.toLowerCase()),D=Array.from(a.toLowerCase());if(a.toLowerCase().includes(n.toLowerCase()))return!0;let re=0,me=0,oe=0,Ie=0;for(let f=0;f<j.length;f++){const b=j[f];let C=!1;for(let P=me;P<D.length;P++)if(D[P]===b){re++,C=!0,P===me?(oe++,Ie=Math.max(Ie,oe)):oe=1,me=P+1;break}if(!C){for(let P=0;P<D.length;P++)if(D[P]===b){re++,C=!0,oe=1,me=P+1;break}}C||(oe=0)}const y=re/j.length,i=Ie/j.length*.3;return y*.7+i>=.6};r.forEach(n=>{const a=gt?.[n.toString()];if(a&&a.tw){const j=a.tw;let D=!1;if(ke)D=s.every(re=>c(re,j));else{const re=j.toLowerCase(),me=We.trim().toLowerCase();D=re===me}D&&o.add(n)}}),r=o}if(r.size===0)return K("未找到符合條件的物品","warning"),null;const M=await Mt();St(M);const q=Array.from(r);let S=q.filter(o=>M.has(o));const v=q.filter(o=>!M.has(o));if(S.length===0&&v.length===0)return K("未找到符合條件的物品","warning"),null;S.length===0&&v.length>0&&pe(!0);const R=await at();return S=S.sort((o,s)=>{const c=R[o?.toString()]||null,n=R[s?.toString()]||null;return c!==null&&n!==null?n-c:c!==null?-1:n!==null?1:s-o}),!e&&S.length>nt?($e({total:S.length,limit:nt}),null):{itemIds:r,tradeableItemIds:S,untradeableItemIds:v}},[F,te,O,H,be,we,We,ke,K,Wt,dt,zt,at,Rt]),Ht=l.useCallback(async()=>{if($e(null),Ye)return;const e=++g.current;W.current&&(W.current.abort(),W.current=null),J.current++,qe.current=!1,Re(!1),X(!1),ee([]),fe([]),pe(!1),Me({}),Le({}),De({}),Ae({}),xe({}),qt([]),he(1),et(!0),setTimeout(()=>{et(!1)},1500);try{if(U(!0),e!==g.current){U(!1);return}const r=await Gt();if(e!==g.current){U(!1);return}if(!r){U(!1);return}const{tradeableItemIds:k,untradeableItemIds:u}=r;if(e!==g.current){U(!1);return}$e(null);const M=await Mt();if(e!==g.current){U(!1);return}St(M);const q=k.filter(R=>M.has(R)),S=await at();if(e!==g.current){U(!1);return}const v=async(R,o)=>{if(e!==g.current)return;const s=S,n=[...o?R.filter(y=>M.has(y)):R].sort((y,i)=>{const d=s[y?.toString()]||null,f=s[i?.toString()]||null;return d!==null&&f!==null?f-d:d!==null?-1:f!==null?1:i-y}),a=20,j=n.slice(0,a),D=o?j.filter(y=>M.has(y)):j,me=D.map(y=>{const d=gt[y?.toString()]?.tw||`物品 (ID: ${y})`;return{id:y,name:d,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((y,i)=>{const d=s[y.id?.toString()]||null,f=s[i.id?.toString()]||null;return d!==null&&f!==null?f-d:d!==null?-1:f!==null?1:i.id-y.id});if(o?(ee([]),Qe.flushSync(()=>{ee(me)}),(async()=>{const y=D.map(b=>Ke(b)),i=(await Promise.all(y)).filter(b=>b!==null);if(e!==g.current)return;const f=i.filter(b=>M.has(b.id)).sort((b,C)=>{const P=s[b.id?.toString()]||null,m=s[C.id?.toString()]||null;return P!==null&&m!==null?m-P:P!==null?-1:m!==null?1:C.id-b.id});e===g.current&&ee(f)})().catch(y=>{console.error("Error loading initial item details:",y)})):(fe(me),(async()=>{const y=j.map(f=>Ke(f)),i=(await Promise.all(y)).filter(f=>f!==null);if(e!==g.current)return;const d=i.sort((f,b)=>{const C=s[f.id?.toString()]||null,P=s[b.id?.toString()]||null;return C!==null&&P!==null?P-C:C!==null?-1:P!==null?1:b.id-f.id});e===g.current&&fe(d)})().catch(y=>{console.error("Error loading untradeable item details:",y)})),O&&H&&n.length>0&&o){if(e!==g.current)return;W.current&&W.current.abort();const y=++J.current;W.current=new AbortController;const i=W.current.signal;qe.current=!0,Re(!0),X(!0),(async()=>{const d=H===O.section,f=d?O.section:H,b=(m,h,I)=>{const p=m?.world?.[I],N=h?.world?.[I],E=m?.dc?.[I],A=h?.dc?.[I],B=d?E!==void 0?E:p:p!==void 0?p:void 0,T=d?A!==void 0?A:N:N!==void 0?N:void 0;if(I==="quantity"){if(B!==void 0||T!==void 0)return(B||0)+(T||0)}else{if(B!==void 0&&T!==void 0)return Math.min(B,T);if(T!==void 0)return T;if(B!==void 0)return B}return null},C=async(m,h)=>{if(i.aborted||y!==J.current||e!==g.current)return;let I;m===0?I=20:m===1?I=50:I=100;const p=n.slice(h,h+I);if(p.length===0)return;const N=p.join(",");try{const E=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(f)}/${N}`,{signal:i});if(i.aborted||y!==J.current||e!==g.current)return;const A=await E.json();if(A&&A.results){const B={},T={},se={},tt={},ze={};A.results.forEach(w=>{const x=w.itemId,Se=b(w.nq?.dailySaleVelocity,w.hq?.dailySaleVelocity,"quantity");let ce=null;if(d)ce=b(w.nq?.averageSalePrice,w.hq?.averageSalePrice,"price");else{const Q=w.nq?.averageSalePrice?.world?.price,V=w.hq?.averageSalePrice?.world?.price,_=w.nq?.averageSalePrice?.dc?.price,G=w.hq?.averageSalePrice?.dc?.price,ae=Q!==void 0?Q:_,je=V!==void 0?V:G;ae!==void 0&&je!==void 0?ce=Math.min(ae,je):je!==void 0?ce=je:ae!==void 0&&(ce=ae)}const le=b(w.nq?.minListing,w.hq?.minListing,"price"),Ne=b(w.nq?.recentPurchase,w.hq?.recentPurchase,"price");let de=null;if(le!=null)if(d)de=le;else{const Q=w.nq?.minListing?.world?.price,V=w.hq?.minListing?.world?.price;let _=null;if(Q!==void 0&&V!==void 0?_=V<=Q?w.hq?.minListing?.world:w.nq?.minListing?.world:V!==void 0?_=w.hq?.minListing?.world:Q!==void 0&&(_=w.nq?.minListing?.world),_!==null){const G=_?.region;de={price:le},G!==void 0&&(de.region=G)}}let ne=null;if(Ne!=null)if(d)ne=Ne;else{const Q=w.nq?.recentPurchase?.world?.price,V=w.hq?.recentPurchase?.world?.price;let _=null;Q!==void 0&&V!==void 0?_=V<=Q?w.hq?.recentPurchase?.world:w.nq?.recentPurchase?.world:V!==void 0?_=w.hq?.recentPurchase?.world:Q!==void 0&&(_=w.nq?.recentPurchase?.world);const G=_?.region;ne={price:Ne},G!==void 0&&(ne.region=G)}Se!=null&&(B[x]=Se),ce!=null&&(T[x]=Math.round(ce)),de!=null&&(se[x]=de),ne!=null&&(tt[x]=ne),ze[x]=!0}),p.forEach(w=>{ze.hasOwnProperty(w)||(ze[w]=!1)}),!i.aborted&&y===J.current&&e===g.current&&(Qe.flushSync(()=>{Me(w=>({...w,...B})),Le(w=>({...w,...T})),De(w=>({...w,...se})),Ae(w=>({...w,...tt})),xe(w=>({...w,...ze}))}),m===0&&X(!1))}}catch(E){if(E.name==="AbortError"||i.aborted)return;console.error("Error fetching market data:",E);const A={};p.forEach(B=>{A[B]=!1}),!i.aborted&&y===J.current&&e===g.current&&Qe.flushSync(()=>{xe(B=>({...B,...A}))})}},P=async(m,h)=>{if(i.aborted||y!==J.current||e!==g.current)return;if(h>=n.length){y===J.current&&e===g.current&&!i.aborted&&(X(!1),qe.current=!1,Re(!1));return}if(await C(m,h),i.aborted||y!==J.current||e!==g.current)return;let I;m===0?I=20:m===1?I=50:I=100;const p=h+I;p<n.length?await new Promise(N=>{setTimeout(()=>{P(m+1,p).then(N)},m===0?0:100)}):y===J.current&&e===g.current&&!i.aborted&&(X(!1),qe.current=!1,Re(!1))};try{await P(0,0)}catch(m){m.name!=="AbortError"&&console.error("Error in market data fetch:",m)}})().catch(d=>{d.name!=="AbortError"&&console.error("Error in market data fetch:",d)})}const oe=50,Ie=async y=>{if(e!==g.current)return;const i=a+y*oe;if(i>=n.length)return;const d=n.slice(i,i+oe);if(d.length===0)return;const f=d.map(m=>Ke(m)),b=(await Promise.all(f)).filter(m=>m!==null);if(e!==g.current)return;const P=(o?b.filter(m=>M.has(m.id)):b).sort((m,h)=>{const I=S[m.id?.toString()]||null,p=S[h.id?.toString()]||null;return I!==null&&p!==null?p-I:I!==null?-1:p!==null?1:h.id-m.id});e===g.current&&(o?ee(m=>[...m,...P].sort((I,p)=>{const N=S[I.id?.toString()]||null,E=S[p.id?.toString()]||null;return N!==null&&E!==null?E-N:N!==null?-1:E!==null?1:p.id-I.id})):fe(m=>[...m,...P].sort((I,p)=>{const N=S[I.id?.toString()]||null,E=S[p.id?.toString()]||null;return N!==null&&E!==null?E-N:N!==null?-1:E!==null?1:p.id-I.id})),await new Promise(m=>{setTimeout(()=>{Ie(y+1).then(m)},50)}))};n.length>a&&Ie(0).catch(y=>{console.error("Error loading remaining batches:",y)})};if(q.length>0?(pe(!1),v(q,!0).catch(R=>{console.error("Error loading tradeable items progressively:",R)}),u.length>0&&v(u,!1).catch(R=>{console.error("Error loading untradeable items:",R)})):u.length>0&&v(u,!1).catch(R=>{console.error("Error loading untradeable items:",R)}),e!==g.current){U(!1);return}(q.length>0||u.length>0)&&K(`找到 ${q.length} 個可交易物品${u.length>0?`、${u.length} 個不可交易物品`:""}`,"success"),U(!1)}catch(r){if(e!==g.current)return;console.error("Filter search error:",r),K("搜索失敗，請稍後再試","error"),X(!1),U(!1)}},[F,te,O,H,K,z,Z,We,be,we,ke,Ye]);return t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 via-purple-950/30 to-slate-950 text-white",children:[t.jsx(qr,{onSearch:er,isSearching:Z,searchText:tr,setSearchText:rt,isServerDataLoaded:Ue,selectedDcName:O?.section,onItemSelect:pt,showNavigationButtons:!0,activePage:"advanced-search",onTaxRatesClick:rr,onAdvancedSearchClick:()=>{rt(""),xt("/advanced-search")},onMSQPriceCheckerClick:()=>{rt(""),xt("/msq-price-checker")},onUltimatePriceKingClick:()=>{rt(""),xt("/ultimate-price-king")}}),t.jsx("div",{className:"fixed right-2 mid:right-4 left-2 mid:left-auto z-50 space-y-2 max-w-sm mid:max-w-none top-[60px] mid:top-4",children:Qt.map(e=>t.jsx(Rr,{message:e.message,type:e.type,onClose:()=>Ot(e.id)},e.id))}),t.jsx("div",{className:"pt-24 pb-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-ffxiv-gold mb-2",children:"進階搜尋"}),t.jsx("p",{className:"text-gray-400 text-sm sm:text-base",children:"批量搜尋多個物品的市場價格，或使用篩選條件進行搜尋。"})]}),t.jsxs("div",{className:"mb-6 flex gap-2 border-b border-purple-500/30",children:[t.jsx("button",{onClick:()=>{bt("filter"),ir(""),$e(null),Ge(1),He(999),jt(""),pe(!1),ee([]),fe([]),Me({}),Le({}),De({}),Ae({}),xe({}),he(1),W.current&&W.current.abort(),X(!1)},className:`px-4 py-2 font-semibold transition-all border-b-2 ${Y==="filter"?"text-ffxiv-gold border-ffxiv-gold":"text-gray-400 border-transparent hover:text-gray-300"}`,children:"篩選搜尋"}),t.jsx("div",{className:"relative",title:"敬请期待",children:t.jsx("button",{onClick:()=>{},disabled:wt,className:"px-4 py-2 font-semibold transition-all border-b-2 text-gray-500 border-transparent cursor-not-allowed opacity-50",children:"批量搜尋（開發中）"})})]}),Y==="batch"&&!wt,Y==="filter"&&t.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4 sm:p-6 mb-6",children:[t.jsx("div",{className:"bg-slate-700/80 border border-slate-500/50 rounded-lg p-4 mb-6",children:t.jsx("p",{className:"text-sm text-gray-200 leading-relaxed",children:"這個頁面測試量過於龐大，作者個人時間有限。各位使用大大有發現bug歡迎參考主頁上的巴哈或dc方式回報，感激感激"})}),t.jsxs("div",{className:"mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6 items-stretch",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇職業"}),t.jsxs("div",{className:"space-y-[0.86821875rem]",children:[t.jsxs("div",{className:"flex flex-wrap gap-2",children:[ge.tank.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)}),ge.tank.length>0&&ge.healer.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ge.healer.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})]}),t.jsxs("div",{className:"flex flex-wrap gap-2 pt-[0.5788125rem] border-t border-purple-500/10",children:[ge.melee.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)}),ge.melee.length>0&&ge.ranged.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ge.ranged.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-[0.5788125rem] border-t border-purple-500/10",children:[ge.caster.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:ge.caster.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})}),t.jsx("div",{className:"flex flex-wrap gap-2",children:vr.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})})]}),t.jsx("div",{className:"flex flex-wrap gap-2 pt-[0.5788125rem] border-t border-purple-500/20",children:wr.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})})]}),F.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",F.length," 個職業"]})]}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇物品分類"}),t.jsxs("div",{className:"border border-purple-500/30 rounded-lg p-3 bg-slate-900/30 h-[290px] flex flex-col",children:[t.jsx("div",{className:"mb-3 flex-shrink-0",children:t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{ref:kt,type:"text",value:Te,onChange:e=>Ct(e.target.value),placeholder:"篩選搜尋分類",className:"w-full pl-9 pr-3 py-2 bg-slate-800/60 backdrop-blur-sm border border-purple-500/20 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 transition-all text-xs"}),Te&&t.jsx("button",{onClick:()=>Ct(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors",title:"清除",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:t.jsxs("div",{className:"space-y-3",children:[[...$.weapons,...$.armor,...$.otherEquipment,...$.accessories].length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-ffxiv-gold mb-2 px-1",children:"裝備類"}),[...$.weapons,...$.armor,...$.otherEquipment].length>0&&t.jsx("div",{className:"grid grid-cols-4 gap-2 mb-2",children:[...$.weapons,...$.armor,...$.otherEquipment].map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})}),$.accessories.length>0&&t.jsx("div",{className:"grid grid-cols-4 gap-2",children:$.accessories.map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),[...$.weapons,...$.armor,...$.otherEquipment,...$.accessories].length>0&&$.miscellaneous.length>0&&t.jsx("div",{className:"border-t border-purple-500/30 my-2"}),$.miscellaneous.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-400 mb-2 px-1",children:"雜物類"}),t.jsx("div",{className:"grid grid-cols-4 gap-2",children:$.miscellaneous.map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),Te.trim()&&$.weapons.length===0&&$.armor.length===0&&$.accessories.length===0&&$.otherEquipment.length===0&&$.miscellaneous.length===0&&t.jsx("div",{className:"py-8 text-center",children:t.jsxs("div",{className:"text-sm text-gray-400",children:["沒有找到匹配「",Te,"」的分類"]})})]})})]}),te.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",te.length," 個分類"]}),t.jsx("div",{className:"mt-2 text-xs text-yellow-400"})]})]}),O&&t.jsxs("div",{className:"mb-6 flex flex-col lg:flex-row lg:justify-between gap-8 lg:gap-10",children:[t.jsxs("div",{className:"flex-shrink-0",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"裝備等級範圍"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{type:"number",min:"1",max:"999",value:gr&&be===1?"":be,onChange:e=>{const r=e.target.value;if(r===""){Ge(1);return}const k=parseInt(r);if(!isNaN(k)){const u=Math.max(1,Math.min(999,k));Ge(u),u>we&&He(u)}},onFocus:()=>{Tt(!0)},onBlur:e=>{Tt(!1),(e.target.value===""||e.target.value==="1")&&Ge(1)},disabled:Pe||z,placeholder:"1",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"}),t.jsx("div",{className:"text-gray-400",children:"~"}),t.jsx("input",{type:"number",min:"1",max:"999",value:mr&&we===999?"":we,onChange:e=>{const r=e.target.value;if(r===""){He(999);return}const k=parseInt(r);if(!isNaN(k)){const u=Math.max(1,Math.min(999,k));He(u),u<be&&Ge(u)}},onFocus:()=>{_t(!0)},onBlur:e=>{_t(!1),(e.target.value===""||e.target.value==="999")&&He(999)},disabled:Pe||z,placeholder:"999",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"})]})]}),t.jsxs("div",{className:"w-full lg:w-auto lg:ml-auto",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"伺服器選擇"}),t.jsx(Er,{datacenters:Kt,worlds:mt,selectedWorld:O,onWorldChange:Zt,selectedServerOption:H,onServerOptionChange:Xt,serverOptions:Yt,disabled:Pe||z})]})]}),Je&&t.jsx("div",{className:"mb-4 p-4 bg-yellow-900/40 border-2 border-yellow-500/50 rounded-lg",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"text-2xl",children:"⚠️"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-yellow-400 font-semibold mb-2",children:"找到的物品過多"}),t.jsxs("p",{className:"text-sm text-gray-300 mb-3",children:["找到 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Je.total})," 個可交易物品， 超過建議上限 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Je.limit})," 個。 處理過多物品可能會導致搜索時間過長或性能問題。"]}),t.jsxs("div",{className:"flex gap-2 flex-wrap",children:[t.jsx("button",{onClick:async()=>{const e=++g.current;W.current&&(W.current.abort(),W.current=null),J.current++,qe.current=!1,Re(!1),X(!1),$e(null),U(!0),et(!1),ee([]),fe([]),pe(!1),Me({}),Le({}),De({}),Ae({}),xe({}),qt([]),et(!0),setTimeout(()=>{et(!1)},1500);try{const r=await Gt(!0);if(e!==g.current){U(!1);return}if(!r){U(!1);return}let{tradeableItemIds:k,untradeableItemIds:u}=r;if(e!==g.current){U(!1);return}const M=await Mt();if(e!==g.current){U(!1);return}St(M);const S=k.filter(o=>M.has(o)).slice(0,nt);K(`已限制為前 ${S.length} 個物品，正在獲取市場數據...`,"warning");const v=await at();if(e!==g.current){U(!1);return}const R=async(o,s)=>{if(e!==g.current)return;const c=v,a=[...s?o.filter(i=>M.has(i)):o].sort((i,d)=>{const f=c[i?.toString()]||null,b=c[d?.toString()]||null;return f!==null&&b!==null?b-f:f!==null?-1:b!==null?1:d-i}),j=20,D=a.slice(0,j),re=s?D.filter(i=>M.has(i)):D,oe=re.map(i=>{const f=gt[i?.toString()]?.tw||`物品 (ID: ${i})`;return{id:i,name:f,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((i,d)=>{const f=c[i.id?.toString()]||null,b=c[d.id?.toString()]||null;return f!==null&&b!==null?b-f:f!==null?-1:b!==null?1:d.id-i.id});if(s?(ee([]),pe(!1),Qe.flushSync(()=>{ee(oe)}),(async()=>{const i=re.map(C=>Ke(C)),d=(await Promise.all(i)).filter(C=>C!==null);if(e!==g.current)return;const b=d.filter(C=>M.has(C.id)).sort((C,P)=>{const m=c[C.id?.toString()]||null,h=c[P.id?.toString()]||null;return m!==null&&h!==null?h-m:m!==null?-1:h!==null?1:P.id-C.id});e===g.current&&ee(b)})().catch(i=>{console.error("Error loading initial item details:",i)})):(fe(oe),(async()=>{const i=D.map(b=>Ke(b)),d=(await Promise.all(i)).filter(b=>b!==null);if(e!==g.current)return;const f=d.sort((b,C)=>{const P=c[b.id?.toString()]||null,m=c[C.id?.toString()]||null;return P!==null&&m!==null?m-P:P!==null?-1:m!==null?1:C.id-b.id});e===g.current&&fe(f)})().catch(i=>{console.error("Error loading untradeable item details:",i)})),O&&H&&a.length>0&&s){W.current&&W.current.abort();const i=++J.current;W.current=new AbortController;const d=W.current.signal;qe.current=!0,Re(!0),X(!0),(async()=>{const f=H===O.section,b=f?O.section:H,C=(h,I,p)=>{const N=h?.world?.[p],E=I?.world?.[p],A=h?.dc?.[p],B=I?.dc?.[p],T=f?A!==void 0?A:N:N!==void 0?N:void 0,se=f?B!==void 0?B:E:E!==void 0?E:void 0;if(p==="quantity"){if(T!==void 0||se!==void 0)return(T||0)+(se||0)}else{if(T!==void 0&&se!==void 0)return Math.min(T,se);if(se!==void 0)return se;if(T!==void 0)return T}return null},P=async(h,I)=>{if(d.aborted||i!==J.current||e!==g.current)return;let p;h===0?p=20:h===1?p=50:p=100;const N=a.slice(I,I+p);if(N.length===0)return;const E=N.join(",");try{const A=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(b)}/${E}`,{signal:d});if(d.aborted||i!==J.current||e!==g.current)return;const B=await A.json();if(B&&B.results){const T={},se={},tt={},ze={},w={};B.results.forEach(x=>{const Se=x.itemId,ce=C(x.nq?.dailySaleVelocity,x.hq?.dailySaleVelocity,"quantity");let le=null;if(f)le=C(x.nq?.averageSalePrice,x.hq?.averageSalePrice,"price");else{const V=x.nq?.averageSalePrice?.world?.price,_=x.hq?.averageSalePrice?.world?.price,G=x.nq?.averageSalePrice?.dc?.price,ae=x.hq?.averageSalePrice?.dc?.price,je=V!==void 0?V:G,ft=_!==void 0?_:ae;je!==void 0&&ft!==void 0?le=Math.min(je,ft):ft!==void 0?le=ft:je!==void 0&&(le=je)}const Ne=C(x.nq?.minListing,x.hq?.minListing,"price"),de=C(x.nq?.recentPurchase,x.hq?.recentPurchase,"price");let ne=null;if(Ne!=null)if(f)ne=Ne;else{const V=x.nq?.minListing?.world?.price,_=x.hq?.minListing?.world?.price;let G=null;if(V!==void 0&&_!==void 0?G=_<=V?x.hq?.minListing?.world:x.nq?.minListing?.world:_!==void 0?G=x.hq?.minListing?.world:V!==void 0&&(G=x.nq?.minListing?.world),G!==null){const ae=G?.region;ne={price:Ne},ae!==void 0&&(ne.region=ae)}}let Q=null;if(de!=null)if(f)Q=de;else{const V=x.nq?.recentPurchase?.world?.price,_=x.hq?.recentPurchase?.world?.price;let G=null;V!==void 0&&_!==void 0?G=_<=V?x.hq?.recentPurchase?.world:x.nq?.recentPurchase?.world:_!==void 0?G=x.hq?.recentPurchase?.world:V!==void 0&&(G=x.nq?.recentPurchase?.world);const ae=G?.region;Q={price:de},ae!==void 0&&(Q.region=ae)}ce!=null&&(T[Se]=ce),le!=null&&(se[Se]=Math.round(le)),ne!=null&&(tt[Se]=ne),Q!=null&&(ze[Se]=Q),w[Se]=!0}),N.forEach(x=>{w.hasOwnProperty(x)||(w[x]=!1)}),!d.aborted&&i===J.current&&e===g.current&&(Qe.flushSync(()=>{Me(x=>({...x,...T})),Le(x=>({...x,...se})),De(x=>({...x,...tt})),Ae(x=>({...x,...ze})),xe(x=>({...x,...w}))}),h===0&&X(!1))}}catch(A){if(A.name==="AbortError"||d.aborted)return;console.error("Error fetching market data:",A);const B={};N.forEach(T=>{B[T]=!1}),!d.aborted&&i===J.current&&e===g.current&&Qe.flushSync(()=>{xe(T=>({...T,...B}))})}},m=async(h,I)=>{if(d.aborted||i!==J.current||e!==g.current)return;if(I>=a.length){i===J.current&&e===g.current&&!d.aborted&&(X(!1),qe.current=!1,Re(!1));return}if(await P(h,I),d.aborted||i!==J.current||e!==g.current)return;let p;h===0?p=20:h===1?p=50:p=100;const N=I+p;N<a.length?await new Promise(E=>{setTimeout(()=>{m(h+1,N).then(E)},h===0?0:100)}):i===J.current&&e===g.current&&!d.aborted&&(X(!1),qe.current=!1,Re(!1))};try{await m(0,0)}catch(h){h.name!=="AbortError"&&console.error("Error in market data fetch:",h)}})().catch(f=>{f.name!=="AbortError"&&console.error("Error in market data fetch:",f)})}const Ie=50,y=async i=>{if(e!==g.current)return;const d=j+i*Ie;if(d>=a.length)return;const f=a.slice(d,d+Ie);if(f.length===0)return;const b=f.map(h=>Ke(h)),C=(await Promise.all(b)).filter(h=>h!==null);if(e!==g.current)return;const m=(s?C.filter(h=>M.has(h.id)):C).sort((h,I)=>{const p=v[h.id?.toString()]||null,N=v[I.id?.toString()]||null;return p!==null&&N!==null?N-p:p!==null?-1:N!==null?1:I.id-h.id});e===g.current&&(s?ee(h=>[...h,...m].sort((p,N)=>{const E=v[p.id?.toString()]||null,A=v[N.id?.toString()]||null;return E!==null&&A!==null?A-E:E!==null?-1:A!==null?1:N.id-p.id})):fe(h=>[...h,...m].sort((p,N)=>{const E=v[p.id?.toString()]||null,A=v[N.id?.toString()]||null;return E!==null&&A!==null?A-E:E!==null?-1:A!==null?1:N.id-p.id})),await new Promise(h=>{setTimeout(()=>{y(i+1).then(h)},50)}))};a.length>j&&y(0).catch(i=>{console.error("Error loading remaining batches:",i)})};if(S.length>0?(pe(!1),R(S,!0).catch(o=>{console.error("Error loading tradeable items progressively:",o)}),u.length>0&&R(u,!1).catch(o=>{console.error("Error loading untradeable items:",o)})):u.length>0&&R(u,!1).catch(o=>{console.error("Error loading untradeable items:",o)}),e!==g.current){U(!1);return}(S.length>0||u.length>0)&&K(`找到 ${S.length} 個可交易物品${u.length>0?`、${u.length} 個不可交易物品`:""}`,"success"),U(!1)}catch(r){if(e!==g.current)return;console.error("Continue search error:",r),K("搜索失敗，請稍後再試","error"),X(!1),U(!1)}},className:"confirm-button-attention py-3",children:t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx("span",{children:"確認"}),t.jsxs("span",{children:["繼續搜索（限制為前 ",nt," 個）"]})]})}),t.jsx("button",{onClick:()=>$e(null),className:"px-4 py-2 bg-slate-700/50 border border-gray-500/50 rounded-lg text-gray-300 hover:bg-slate-700/70 transition-all text-sm font-medium",children:"取消"})]})]})]})}),t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("div",{className:"w-[40%] relative",children:[t.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{type:"text",value:We,onChange:e=>jt(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!z&&!Z&&(F.length>0||te.length>0)&&!Je&&Ht()},placeholder:"物品名篩選（多關鍵詞用空格分隔）",disabled:z||Z,className:`w-full py-3 pl-10 pr-20 rounded-lg bg-slate-900/90 backdrop-blur-sm border text-white placeholder-gray-400 focus:outline-none focus:ring-1 transition-all text-sm shadow-lg ${z||Z?"border-slate-700/30 cursor-not-allowed opacity-60":"border-purple-500/40 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 shadow-purple-500/20"}`}),t.jsxs("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-10 flex items-center gap-1.5",children:[t.jsxs("label",{className:"flex items-center cursor-pointer group",title:ke?"開啟精準搜尋":"關閉精準搜尋",children:[t.jsx("input",{type:"checkbox",checked:!ke,onChange:e=>pr(!e.target.checked),disabled:z||Z,className:"sr-only"}),t.jsx("div",{className:`relative w-9 h-5 rounded-full transition-colors duration-200 ${z||Z?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${ke?"bg-slate-600/60":"bg-ffxiv-gold/80"}`,children:t.jsx("div",{className:`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-200 ${ke?"translate-x-0":"translate-x-4"}`})})]}),t.jsx("span",{className:`text-xs whitespace-nowrap select-none ${z||Z?"text-gray-500":ke?"text-gray-400":"text-ffxiv-gold"}`,children:"精準"})]})]}),t.jsx("button",{onClick:Ht,disabled:z||Z||Ye||F.length===0&&te.length===0||Je!==null,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${z||Z||Ye||F.length===0&&te.length===0||Je!==null?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-gradient-to-r from-ffxiv-gold to-yellow-500 text-slate-900 hover:shadow-[0_0_20px_rgba(212,175,55,0.5)]"}`,children:z||Z?"搜索中...":"搜索"}),t.jsx("button",{onClick:()=>{$t([]),Bt([]),Ge(1),He(999),jt(""),ee([]),fe([]),pe(!1),Me({}),Le({}),De({}),Ae({}),xe({}),he(1),$e(null),W.current&&W.current.abort(),X(!1),U(!1)},disabled:z||Z,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${z||Z?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-red-600/60 text-white border border-red-500/50 hover:bg-red-600/80 hover:border-red-400/70 hover:shadow-[0_0_20px_rgba(220,38,38,0.5)]"}`,children:"清空篩選"})]})]}),(()=>{const e=ie.length>0;if(!(Y==="filter"?e||!e&&ue.length>0:Y==="batch"&&!wt))return null;const u=Y==="filter"?Ce?ue:ie:[],M=(()=>{if(!ye)return{};const n={};return u.forEach(a=>{const j=ye[a.id?.toString()]!==void 0?ye[a.id.toString()]:0;n[j]=(n[j]||0)+1}),n})();let q=u,S=q;if(At&&q.some(a=>It?.[a.id]===!0)&&(S=q.filter(a=>It?.[a.id]===!0)),ot.length>0&&ye){const n=ot[0];q=q.filter(a=>(ye[a.id?.toString()]!==void 0?ye[a.id.toString()]:0)===n),S=S.filter(a=>(ye[a.id?.toString()]!==void 0?ye[a.id.toString()]:0)===n)}const v=Math.ceil(q.length/ve),o=((v>0?Math.min(L,v):1)-1)*ve,s=o+ve,c=q.slice(o,s);return t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[t.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-ffxiv-gold",children:["搜索結果 (",q.length," 個物品",S.length!==q.length?`，顯示 ${S.length} 個`:"",")"]}),O&&H&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-900/40 via-pink-900/30 to-indigo-900/40 border border-purple-500/30 rounded-lg backdrop-blur-sm",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-ffxiv-gold animate-pulse"}),t.jsx("span",{className:"text-xs sm:text-sm font-semibold text-ffxiv-gold",children:H===O.section?`${O.section} (全服)`:mt[H]||`伺服器 ${H}`})]}),Y==="filter"&&ue.length>0&&Ue&&!Pe&&!st&&!Nt&&!z&&t.jsx("button",{onClick:()=>{pe(!Ce),he(1)},className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all duration-200 backdrop-blur-sm shadow-sm ${Ce?"bg-gradient-to-r from-slate-700/70 via-slate-600/60 to-slate-700/70 text-gray-200 border border-slate-500/50 hover:from-slate-600/80 hover:via-slate-500/70 hover:to-slate-600/80 hover:border-slate-400/60 hover:shadow-md":"bg-gradient-to-r from-slate-800/70 via-slate-700/60 to-slate-800/70 text-gray-300 border border-slate-600/50 hover:from-slate-700/80 hover:via-slate-600/70 hover:to-slate-700/80 hover:border-slate-500/60 hover:shadow-md hover:text-gray-200"}`,children:Ce?"隱藏不可交易物品":`顯示不可以交易物品${ue.length}個`}),xr&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-slate-800/50 border border-purple-500/30 rounded-lg",children:[t.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-ffxiv-gold"}),t.jsx("span",{className:"text-xs text-gray-300",children:"載入中..."})]})]}),q.length>ve&&t.jsxs("div",{className:"mb-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:ve,onChange:n=>{const a=parseInt(n.target.value,10);Ft(a),he(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",o+1,"-",Math.min(s,q.length)," / ",q.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Ee(1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Ee(L-1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",L," / ",v," 頁"]}),t.jsx("button",{onClick:()=>Ee(L+1),disabled:L===v,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===v?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Ee(v),disabled:L===v,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===v?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]}),t.jsx(Mr,{items:c,onSelect:n=>{if(pt){const a=new URLSearchParams;H&&a.set("server",H);const j=a.toString(),D=`/item/${n.id}${j?"?"+j:""}`;pt(n),window.open(D,"_blank")}},selectedItem:null,marketableItems:At,itemVelocities:or,itemAveragePrices:cr,itemMinListings:dr,itemRecentPurchases:ur,itemTradability:It,isLoadingVelocities:Pe,averagePriceHeader:"平均價格",getSimplifiedChineseName:Br,addToast:K,selectedRarities:ot,setSelectedRarities:qt,raritiesData:ye,externalRarityFilter:!0,externalRarityCounts:M,isServerDataLoaded:Ue,isRaritySelectorDisabled:!Ue||Pe||st||Nt||z}),q.length>ve&&t.jsxs("div",{className:"mt-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:ve,onChange:n=>{const a=parseInt(n.target.value,10);Ft(a),he(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",o+1,"-",Math.min(s,q.length)," / ",q.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Ee(1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Ee(L-1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",L," / ",v," 頁"]}),t.jsx("button",{onClick:()=>Ee(L+1),disabled:L===v,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===v?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Ee(v),disabled:L===v,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===v?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]})]})})()]})}),t.jsx(Lr,{isOpen:nr,onClose:()=>sr(!1),taxRates:lr,worlds:mt,isLoading:ar,selectedWorld:O,selectedServerOption:H})]})}export{Kr as default};

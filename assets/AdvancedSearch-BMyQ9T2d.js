import{_ as ht,g as Mt,T as qr,a as Rr,S as Er,I as Mr,b as Lr}from"./index-p30MSiX7.js";import{u as Dr,b as Ar,a as $r,r as a,d as Qe,j as t}from"./react-vendor-DmEpS5Kz.js";import{l as Wt,g as Ke,b as Br}from"./services-data-CB3AkOTv.js";import{t as Tr}from"./tw-job-abbr-xwaoke-z.js";import{a as gt}from"./teamcraft-data-u2h6--oi.js";import"./axios-B9ygI19o.js";import"./vendor-dPMYpV4t.js";import"./opencc-C1Qz6KEM.js";const _r={1:{tw:"格鬥武器"},2:{tw:"單手劍"},3:{tw:"大斧"},4:{tw:"弓"},5:{tw:"長槍"},6:{tw:"單手咒杖"},7:{tw:"雙手咒杖"},8:{tw:"單手幻杖"},9:{tw:"雙手幻杖"},10:{tw:"魔導書"},11:{tw:"盾"},12:{tw:"木工工具（主工具）"},13:{tw:"木工工具（副工具）"},14:{tw:"鍛造工具（主工具）"},15:{tw:"鍛造工具（副工具）"},16:{tw:"甲冑工具（主工具）"},17:{tw:"甲冑工具（副工具）"},18:{tw:"金工工具（主工具）"},19:{tw:"金工工具（副工具）"},20:{tw:"皮革工具（主工具）"},21:{tw:"皮革工具（副工具）"},22:{tw:"裁縫工具（主工具）"},23:{tw:"裁縫工具（副工具）"},24:{tw:"鍊金工具（主工具）"},25:{tw:"鍊金工具（副工具）"},26:{tw:"烹調工具（主工具）"},27:{tw:"烹調工具（副工具）"},28:{tw:"採掘工具（主工具）"},29:{tw:"採掘工具（副工具）"},30:{tw:"園藝工具（主工具）"},31:{tw:"園藝工具（副工具）"},32:{tw:"捕魚用具（主工具）"},33:{tw:"釣餌"},34:{tw:"頭部防具"},35:{tw:"身體防具"},36:{tw:"腿部防具"},37:{tw:"手部防具"},38:{tw:"腳部防具"},39:{tw:"停止流通道具"},40:{tw:"項鍊"},41:{tw:"耳飾"},42:{tw:"手鐲"},43:{tw:"戒指"},44:{tw:"藥品"},45:{tw:"食材"},46:{tw:"食品"},47:{tw:"水產品"},48:{tw:"石材"},49:{tw:"金屬"},50:{tw:"木材"},51:{tw:"布料"},52:{tw:"皮革"},53:{tw:"骨材"},54:{tw:"鍊金原料"},55:{tw:"染料"},56:{tw:"組件"},57:{tw:"傢俱"},58:{tw:"魔晶石"},59:{tw:"水晶"},60:{tw:"觸媒"},61:{tw:"雜貨"},62:{tw:"靈魂水晶"},63:{tw:"其他"},64:{tw:"房產證書"},65:{tw:"房頂"},66:{tw:"外牆"},67:{tw:"窗戶"},68:{tw:"房門"},69:{tw:"房頂裝飾"},70:{tw:"外牆裝飾"},71:{tw:"門牌"},72:{tw:"院牆"},73:{tw:"內牆"},74:{tw:"地板"},75:{tw:"屋頂照明"},76:{tw:"庭具"},77:{tw:"桌台"},78:{tw:"桌上"},79:{tw:"壁掛"},80:{tw:"地毯"},81:{tw:"寵物"},82:{tw:"栽培用品"},83:{tw:"半魔晶石"},84:{tw:"雙劍"},85:{tw:"雜貨（季節活動）"},86:{tw:"九宮幻卡"},87:{tw:"雙手劍"},88:{tw:"火槍"},89:{tw:"天球儀"},90:{tw:"飛空艇組件（船體）"},91:{tw:"飛空艇組件（艤裝）"},92:{tw:"飛空艇組件（船尾）"},93:{tw:"飛空艇組件（船首）"},94:{tw:"管弦樂琴樂譜"},95:{tw:"繪畫作品"},96:{tw:"武士刀"},97:{tw:"刺劍"},98:{tw:"魔導書（學者專用）"},99:{tw:"捕魚用具（副工具）"},100:{tw:"貨幣"},101:{tw:"潛水艇組件（船體）"},102:{tw:"潛水艇組件（船尾）"},103:{tw:"潛水艇組件（船首）"},104:{tw:"潛水艇組件（艦橋）"},105:{tw:"青魔杖"},106:{tw:"槍刃"},107:{tw:"投擲武器"},108:{tw:"雙手鐮刀"},109:{tw:"賢具"},110:{tw:"二刀流武器"},111:{tw:"筆"},112:{tw:"套裝"}};function Kr({addToast:K,removeToast:Ot,toasts:Qt,datacenters:Kt,worlds:mt,selectedWorld:O,onWorldChange:Zt,selectedServerOption:H,onServerOptionChange:Xt,serverOptions:Yt,isServerDataLoaded:ze,onItemSelect:pt,onSearch:er,searchText:tr,setSearchText:rt,isSearching:Z,onTaxRatesClick:rr,isTaxRatesModalOpen:nr,setIsTaxRatesModalOpen:sr,taxRates:lr,isLoadingTaxRates:ar}){const xt=Dr(),[Lt]=Ar(),Ze=$r(),[Y,bt]=a.useState("filter"),wt=!0,[Dt,ir]=a.useState(""),[Ie,ee]=a.useState([]),[qe,de]=a.useState([]),[Ue,he]=a.useState(!1),vt=a.useRef(!1),yt=a.useRef(""),[or,Re]=a.useState({}),[cr,Ee]=a.useState({}),[dr,Me]=a.useState({}),[ur,Le]=a.useState({}),[It,ge]=a.useState({}),[Se,X]=a.useState(!1),[At,St]=a.useState(null),[Nt,Fr]=a.useState(!1),[Je,De]=a.useState(null),nt=500,[fr,Vr]=a.useState(!0),[F,$t]=a.useState([]),[te,Bt]=a.useState([]),[z,U]=a.useState(!1),[Ae,hr]=a.useState(new Set),[me,Ge]=a.useState(1),[pe,He]=a.useState(999),[gr,Tt]=a.useState(!1),[mr,_t]=a.useState(!1),[We,jt]=a.useState(""),[Ne,pr]=a.useState(!0),[$e,Ct]=a.useState(""),kt=[62],[A,je]=a.useState(1),[Be,Ft]=a.useState(50),[xr,Xe]=a.useState(!1),Oe=a.useRef(null),Te=a.useCallback(e=>{hr(r=>new Set(r).add(e))},[]),W=a.useRef(null),J=a.useRef(0),Ce=a.useRef(!1),[st,ke]=a.useState(!1),g=a.useRef(0);a.useRef(0);const[Ye,et]=a.useState(!1),Pt=a.useRef(null),lt=a.useRef(null),at=a.useCallback(async()=>{if(lt.current)return lt.current;const e=await ht(()=>import("./ilvls-Bj6OKdVo.js"),[]);return lt.current=e.default,lt.current},[]),it=a.useRef(null),[xe,br]=a.useState(null),[ot,qt]=a.useState([]),Vt=a.useCallback(async()=>{if(it.current)return it.current;const e=await ht(()=>import("./rarities-CrVnX0d9.js"),[]);return it.current=e.default,it.current},[]);a.useEffect(()=>{Vt().then(e=>{br(e)})},[Vt]),a.useEffect(()=>{je(1)},[ot]);const ct=a.useRef(null),dt=a.useCallback(async()=>{if(ct.current)return ct.current;const e=await ht(()=>import("./equipment-sIOEhpr0.js"),[]);return ct.current=e.default,ct.current},[]),ut=a.useRef(null),zt=a.useCallback(async()=>{if(ut.current)return ut.current;const e=await ht(()=>import("./ui-categories-B7UiuPPW.js"),[]);return ut.current=e.default,ut.current},[]),Rt=a.useCallback(e=>({1:"GLA",2:"PGL",3:"MRD",4:"LNC",5:"ARC",6:"CNJ",7:"THM",8:"CRP",9:"BSM",10:"ARM",11:"GSM",12:"LTW",13:"WVR",14:"ALC",15:"CUL",16:"MIN",17:"BTN",18:"FSH",19:"PLD",20:"MNK",21:"WAR",22:"DRG",23:"BRD",24:"WHM",25:"BLM",26:"ACN",27:"SMN",28:"SCH",29:"ROG",30:"NIN",31:"MCH",32:"DRK",33:"AST",34:"SAM",35:"RDM",36:"BLU",37:"GNB",38:"DNC",39:"RPR",40:"SGE",41:"VPR",42:"PCT"})[e],[]);a.useCallback(async(e=null)=>{{K("批量搜索功能暂时不可用，敬请期待","info");return}},[Dt,O,H,K,Ye,fr]),a.useEffect(()=>{if(!ze)return;const e=`${Ze.pathname}?${Ze.search}`;if(yt.current===e)return;if(Ze.pathname!=="/advanced-search"){yt.current=e;return}const r=Lt.get("q");r&&r.trim()!==""?(Y==="batch"&&bt("filter"),vt.current=!1):(vt.current&&Ie.length>0&&(ee([]),Re({}),Ee({}),Me({}),Le({}),ge({}),je(1)),vt.current=!1),yt.current=e},[Ze.pathname,Ze.search,Lt,ze,Dt,Y,Ie.length,Nt,z,Z]),a.useEffect(()=>{Y==="batch"&&bt("filter")},[Y]),a.useEffect(()=>{if((Se||z||st)&&((Y==="filter"&&Ue?qe:Ie).length>=50||Ie.length>=50||qe.length>=50))Oe.current||(Oe.current=Date.now()),Xe(!0);else if(Oe.current){const P=Date.now()-Oe.current,u=Math.max(0,1e3-P);if(u>0){const E=setTimeout(()=>{Xe(!1),Oe.current=null},u);return()=>clearTimeout(E)}else Xe(!1),Oe.current=null}else Xe(!1)},[Se,z,st,Ue,Ie.length,qe.length,Y]);const{craftingJobs:wr,gatheringJobs:vr,battleJobsByRole:ue}=a.useMemo(()=>{const e=new Set([1,2,3,4,5,6,7,26,29]),r={19:"paladin",20:"monk",21:"warrior",22:"dragoon",23:"bard",24:"whitemage",25:"blackmage",27:"summoner",28:"scholar",30:"ninja",31:"machinist",32:"darkknight",33:"astrologian",34:"samurai",35:"redmage",36:"bluemage",37:"gunbreaker",38:"dancer",39:"reaper",40:"sage",41:"viper",42:"pictomancer",8:"carpenter",9:"blacksmith",10:"armorer",11:"goldsmith",12:"leatherworker",13:"weaver",14:"alchemist",15:"culinarian",16:"miner",17:"botanist",18:"fisher"},P={19:"tank",21:"tank",32:"tank",37:"tank",24:"healer",28:"healer",33:"healer",40:"healer",20:"melee",22:"melee",30:"melee",34:"melee",39:"melee",41:"melee",23:"ranged",31:"ranged",38:"ranged",25:"caster",27:"caster",35:"caster",36:"caster",42:"caster"},u=[],E=[],q={tank:[],healer:[],melee:[],ranged:[],caster:[]};return Object.entries(Tr).forEach(([I,S])=>{const N=parseInt(I,10);if(e.has(N))return;const c=r[N];if(!c)return;const s={id:N,name:S.tw,iconUrl:`https://xivapi.com/cj/companion/${c}.png`};if(N>=8&&N<=15)u.push(s);else if(N>=16&&N<=18)E.push(s);else if(N>=19&&N<=42){const l=P[N];l&&q[l]&&q[l].push(s)}}),u.sort((I,S)=>I.id-S.id),E.sort((I,S)=>I.id-S.id),Object.keys(q).forEach(I=>{q[I].sort((S,N)=>S.id-N.id)}),{craftingJobs:u,gatheringJobs:E,battleJobsByRole:q}},[]),yr=new Set([1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111]),Ir=new Set([12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,99]),Sr={19:[2],20:[1],21:[3],22:[5],23:[4],24:[8,9],25:[6,7],27:[10],28:[10,98],30:[84],31:[88],32:[2,87],33:[89],34:[96],35:[97],36:[105],37:[106],38:[107],39:[108],40:[109],41:[110],42:[111]},Nr={8:12,9:14,10:16,11:18,12:20,13:22,14:24,15:26},jr={8:13,9:15,10:17,11:19,12:21,13:23,14:25,15:27},Cr={19:11},kr={16:28,17:30,18:32},Pr={16:29,17:31,18:99},Ut={主武器:[1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111,12,14,16,18,20,22,24,26,28,30,32],副手武器:[11,13,15,17,19,21,23,25,27,29,31,33,99]},Jt=new Set([34,35,36,37,38,40,41,42,43,62]),_e=a.useMemo(()=>{const e=Object.entries(_r).map(([s,l])=>({id:parseInt(s,10),name:l.tw})).filter(s=>!yr.has(s.id)&&!Ir.has(s.id)&&!kt.includes(s.id)),r=e.filter(s=>Jt.has(s.id)),P=e.filter(s=>!Jt.has(s.id)&&s.id!==11),u=[34,35,37,36,38,41,40,42,43,62];r.sort((s,l)=>{const n=u.indexOf(s.id),o=u.indexOf(l.id);return n!==-1&&o!==-1?n-o:n!==-1?-1:o!==-1?1:s.id-l.id}),P.sort((s,l)=>s.id===39?1:l.id===39?-1:s.id-l.id);const E=[{id:"main_weapon",name:"主手",isGeneric:!0},{id:"offhand_weapon",name:"副手",isGeneric:!0}],q=[34,35,37,36,38],I=[41,40,42,43],S=r.filter(s=>q.includes(s.id)),N=r.filter(s=>I.includes(s.id)),c=r.filter(s=>!q.includes(s.id)&&!I.includes(s.id));return{weapons:E,armor:S,accessories:N,otherEquipment:c,miscellaneous:P}},[]),D=a.useMemo(()=>{if(!$e.trim())return _e;const e=$e.toLowerCase().trim(),r=P=>P.name.toLowerCase().includes(e);return{weapons:_e.weapons.filter(r),armor:_e.armor.filter(r),accessories:_e.accessories.filter(r),otherEquipment:_e.otherEquipment.filter(r),miscellaneous:_e.miscellaneous.filter(r)}},[_e,$e]),Fe=a.useCallback(e=>{$t(r=>r.includes(e)?r.filter(P=>P!==e):[...r,e])},[]),Et=a.useCallback(e=>{Bt(r=>r.includes(e)?r.filter(P=>P!==e):[...r,e]),Ct(""),setTimeout(()=>{Pt.current&&Pt.current.focus()},0)},[]),Pe=a.useCallback(e=>{je(e)},[]),Gt=a.useCallback(async(e=!1)=>{if(F.length===0&&te.length===0)return K("請至少選擇一個職業或分類","warning"),null;if(!O||!H)return K("請選擇伺服器","warning"),null;let r=new Set;const P=F.filter(c=>c>=8&&c<=18),u=F.filter(c=>c>=1&&c<=7||c>=19&&c<=42);if(P.length>0){const{recipes:c}=await Wt();P.forEach(n=>{c.forEach(o=>{o.job===n&&o.result&&r.add(o.result)})});const s=await dt(),l=P.map(n=>Rt(n)).filter(n=>n);Object.entries(s).forEach(([n,o])=>{o.jobs&&Array.isArray(o.jobs)&&l.some($=>o.jobs.includes($))&&r.add(parseInt(n,10))})}if(u.length>0){const c=await dt(),s=u.map(l=>Rt(l)).filter(l=>l);Object.entries(c).forEach(([l,n])=>{n.jobs&&Array.isArray(n.jobs)&&s.some(M=>n.jobs.includes(M))&&r.add(parseInt(l,10))})}if(te.length>0){const c=await zt();let s=new Set;if(te.forEach(l=>{l==="main_weapon"?F.length>0?F.forEach(n=>{const o=Sr[n];o&&o.forEach(re=>s.add(re));const M=Nr[n];M&&s.add(M);const $=kr[n];$&&s.add($)}):Ut.主武器.forEach(n=>s.add(n)):l==="offhand_weapon"?F.length>0?F.forEach(n=>{const o=Cr[n];o&&s.add(o);const M=jr[n];M&&s.add(M);const $=Pr[n];$&&s.add($)}):Ut.副手武器.forEach(n=>s.add(n)):s.add(parseInt(l,10))}),r.size===0&&F.length===0&&Object.keys(gt).forEach(l=>{r.add(parseInt(l,10))}),s.size>0){const l=new Set;r.forEach(n=>{const o=c[n.toString()];kt.includes(o)||o&&s.has(o)&&l.add(n)}),r=l}else{const l=new Set;r.forEach(n=>{const o=c[n.toString()];kt.includes(o)||l.add(n)}),r=l}}if(me>1||pe<999){const c=await dt(),s=new Set;r.forEach(l=>{const n=c[l.toString()];!n||n.level===void 0||n.level===null?me===1&&pe===999&&s.add(l):n.level>=me&&n.level<=pe&&s.add(l)}),r=s}if(We.trim()){const c=new Set,s=We.trim().split(/\s+/).filter(n=>n),l=(n,o)=>{const M=Array.from(n.toLowerCase()),$=Array.from(o.toLowerCase());if(o.toLowerCase().includes(n.toLowerCase()))return!0;let re=0,fe=0,ie=0,be=0;for(let f=0;f<M.length;f++){const b=M[f];let C=!1;for(let k=fe;k<$.length;k++)if($[k]===b){re++,C=!0,k===fe?(ie++,be=Math.max(be,ie)):ie=1,fe=k+1;break}if(!C){for(let k=0;k<$.length;k++)if($[k]===b){re++,C=!0,ie=1,fe=k+1;break}}C||(ie=0)}const v=re/M.length,i=be/M.length*.3;return v*.7+i>=.6};r.forEach(n=>{const o=gt?.[n.toString()];if(o&&o.tw){const M=o.tw;let $=!1;if(Ne)$=s.every(re=>l(re,M));else{const re=M.toLowerCase(),fe=We.trim().toLowerCase();$=re===fe}$&&c.add(n)}}),r=c}if(r.size===0)return K("未找到符合條件的物品","warning"),null;const E=await Mt();St(E);const q=Array.from(r);let I=q.filter(c=>E.has(c));const S=q.filter(c=>!E.has(c));if(I.length===0&&S.length===0)return K("未找到符合條件的物品","warning"),null;I.length===0&&S.length>0&&he(!0);const N=await at();return I=I.sort((c,s)=>{const l=N[c?.toString()]||null,n=N[s?.toString()]||null;return l!==null&&n!==null?n-l:l!==null?-1:n!==null?1:s-c}),!e&&I.length>nt?(De({total:I.length,limit:nt}),null):{itemIds:r,tradeableItemIds:I,untradeableItemIds:S}},[F,te,O,H,me,pe,We,Ne,K,Wt,dt,zt,at,Rt]),Ht=a.useCallback(async()=>{if(De(null),Ye)return;const e=++g.current;W.current&&(W.current.abort(),W.current=null),J.current++,Ce.current=!1,ke(!1),X(!1),ee([]),de([]),he(!1),Re({}),Ee({}),Me({}),Le({}),ge({}),qt([]),et(!0),setTimeout(()=>{et(!1)},1500);try{if(U(!0),e!==g.current){U(!1);return}const r=await Gt();if(e!==g.current){U(!1);return}if(!r){U(!1);return}const{tradeableItemIds:P,untradeableItemIds:u}=r;if(e!==g.current){U(!1);return}De(null);const E=await Mt();if(e!==g.current){U(!1);return}St(E);const q=P.filter(N=>E.has(N)),I=await at();if(e!==g.current){U(!1);return}const S=async(N,c)=>{if(e!==g.current)return;const s=I,n=[...c?N.filter(v=>E.has(v)):N].sort((v,i)=>{const d=s[v?.toString()]||null,f=s[i?.toString()]||null;return d!==null&&f!==null?f-d:d!==null?-1:f!==null?1:i-v}),o=20,M=n.slice(0,o),$=c?M.filter(v=>E.has(v)):M,fe=$.map(v=>{const d=gt[v?.toString()]?.tw||`物品 (ID: ${v})`;return{id:v,name:d,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((v,i)=>{const d=s[v.id?.toString()]||null,f=s[i.id?.toString()]||null;return d!==null&&f!==null?f-d:d!==null?-1:f!==null?1:i.id-v.id});if(c?(ee([]),Qe.flushSync(()=>{ee(fe)}),(async()=>{const v=$.map(b=>Ke(b)),i=(await Promise.all(v)).filter(b=>b!==null);if(e!==g.current)return;const f=i.filter(b=>E.has(b.id)).sort((b,C)=>{const k=s[b.id?.toString()]||null,m=s[C.id?.toString()]||null;return k!==null&&m!==null?m-k:k!==null?-1:m!==null?1:C.id-b.id});e===g.current&&ee(f)})().catch(v=>{console.error("Error loading initial item details:",v)})):(de(fe),(async()=>{const v=M.map(f=>Ke(f)),i=(await Promise.all(v)).filter(f=>f!==null);if(e!==g.current)return;const d=i.sort((f,b)=>{const C=s[f.id?.toString()]||null,k=s[b.id?.toString()]||null;return C!==null&&k!==null?k-C:C!==null?-1:k!==null?1:b.id-f.id});e===g.current&&de(d)})().catch(v=>{console.error("Error loading untradeable item details:",v)})),O&&H&&n.length>0&&c){if(e!==g.current)return;W.current&&W.current.abort();const v=++J.current;W.current=new AbortController;const i=W.current.signal;Ce.current=!0,ke(!0),X(!0),(async()=>{const d=H===O.section,f=d?O.section:H,b=(m,h,y)=>{const p=m?.world?.[y],j=h?.world?.[y],R=m?.dc?.[y],L=h?.dc?.[y],B=d?R!==void 0?R:p:p!==void 0?p:void 0,T=d?L!==void 0?L:j:j!==void 0?j:void 0;if(y==="quantity"){if(B!==void 0||T!==void 0)return(B||0)+(T||0)}else{if(B!==void 0&&T!==void 0)return Math.min(B,T);if(T!==void 0)return T;if(B!==void 0)return B}return null},C=async(m,h)=>{if(i.aborted||v!==J.current||e!==g.current)return;let y;m===0?y=20:m===1?y=50:y=100;const p=n.slice(h,h+y);if(p.length===0)return;const j=p.join(",");try{const R=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(f)}/${j}`,{signal:i});if(i.aborted||v!==J.current||e!==g.current)return;const L=await R.json();if(L&&L.results){const B={},T={},se={},tt={},Ve={};L.results.forEach(w=>{const x=w.itemId,we=b(w.nq?.dailySaleVelocity,w.hq?.dailySaleVelocity,"quantity");let oe=null;if(d)oe=b(w.nq?.averageSalePrice,w.hq?.averageSalePrice,"price");else{const Q=w.nq?.averageSalePrice?.world?.price,V=w.hq?.averageSalePrice?.world?.price,_=w.nq?.averageSalePrice?.dc?.price,G=w.hq?.averageSalePrice?.dc?.price,ae=Q!==void 0?Q:_,ye=V!==void 0?V:G;ae!==void 0&&ye!==void 0?oe=Math.min(ae,ye):ye!==void 0?oe=ye:ae!==void 0&&(oe=ae)}const le=b(w.nq?.minListing,w.hq?.minListing,"price"),ve=b(w.nq?.recentPurchase,w.hq?.recentPurchase,"price");let ce=null;if(le!=null)if(d)ce=le;else{const Q=w.nq?.minListing?.world?.price,V=w.hq?.minListing?.world?.price;let _=null;if(Q!==void 0&&V!==void 0?_=V<=Q?w.hq?.minListing?.world:w.nq?.minListing?.world:V!==void 0?_=w.hq?.minListing?.world:Q!==void 0&&(_=w.nq?.minListing?.world),_!==null){const G=_?.region;ce={price:le},G!==void 0&&(ce.region=G)}}let ne=null;if(ve!=null)if(d)ne=ve;else{const Q=w.nq?.recentPurchase?.world?.price,V=w.hq?.recentPurchase?.world?.price;let _=null;Q!==void 0&&V!==void 0?_=V<=Q?w.hq?.recentPurchase?.world:w.nq?.recentPurchase?.world:V!==void 0?_=w.hq?.recentPurchase?.world:Q!==void 0&&(_=w.nq?.recentPurchase?.world);const G=_?.region;ne={price:ve},G!==void 0&&(ne.region=G)}we!=null&&(B[x]=we),oe!=null&&(T[x]=Math.round(oe)),ce!=null&&(se[x]=ce),ne!=null&&(tt[x]=ne),Ve[x]=!0}),p.forEach(w=>{Ve.hasOwnProperty(w)||(Ve[w]=!1)}),!i.aborted&&v===J.current&&e===g.current&&(Qe.flushSync(()=>{Re(w=>({...w,...B})),Ee(w=>({...w,...T})),Me(w=>({...w,...se})),Le(w=>({...w,...tt})),ge(w=>({...w,...Ve}))}),m===0&&X(!1))}}catch(R){if(R.name==="AbortError"||i.aborted)return;console.error("Error fetching market data:",R);const L={};p.forEach(B=>{L[B]=!1}),!i.aborted&&v===J.current&&e===g.current&&Qe.flushSync(()=>{ge(B=>({...B,...L}))})}},k=async(m,h)=>{if(i.aborted||v!==J.current||e!==g.current)return;if(h>=n.length){v===J.current&&e===g.current&&!i.aborted&&(X(!1),Ce.current=!1,ke(!1));return}if(await C(m,h),i.aborted||v!==J.current||e!==g.current)return;let y;m===0?y=20:m===1?y=50:y=100;const p=h+y;p<n.length?await new Promise(j=>{setTimeout(()=>{k(m+1,p).then(j)},m===0?0:100)}):v===J.current&&e===g.current&&!i.aborted&&(X(!1),Ce.current=!1,ke(!1))};try{await k(0,0)}catch(m){m.name!=="AbortError"&&console.error("Error in market data fetch:",m)}})().catch(d=>{d.name!=="AbortError"&&console.error("Error in market data fetch:",d)})}const ie=50,be=async v=>{if(e!==g.current)return;const i=o+v*ie;if(i>=n.length)return;const d=n.slice(i,i+ie);if(d.length===0)return;const f=d.map(m=>Ke(m)),b=(await Promise.all(f)).filter(m=>m!==null);if(e!==g.current)return;const k=(c?b.filter(m=>E.has(m.id)):b).sort((m,h)=>{const y=I[m.id?.toString()]||null,p=I[h.id?.toString()]||null;return y!==null&&p!==null?p-y:y!==null?-1:p!==null?1:h.id-m.id});e===g.current&&(c?ee(m=>[...m,...k].sort((y,p)=>{const j=I[y.id?.toString()]||null,R=I[p.id?.toString()]||null;return j!==null&&R!==null?R-j:j!==null?-1:R!==null?1:p.id-y.id})):de(m=>[...m,...k].sort((y,p)=>{const j=I[y.id?.toString()]||null,R=I[p.id?.toString()]||null;return j!==null&&R!==null?R-j:j!==null?-1:R!==null?1:p.id-y.id})),await new Promise(m=>{setTimeout(()=>{be(v+1).then(m)},50)}))};n.length>o&&be(0).catch(v=>{console.error("Error loading remaining batches:",v)})};if(q.length>0?(he(!1),S(q,!0).catch(N=>{console.error("Error loading tradeable items progressively:",N)}),u.length>0&&S(u,!1).catch(N=>{console.error("Error loading untradeable items:",N)})):u.length>0&&S(u,!1).catch(N=>{console.error("Error loading untradeable items:",N)}),e!==g.current){U(!1);return}(q.length>0||u.length>0)&&K(`找到 ${q.length} 個可交易物品${u.length>0?`、${u.length} 個不可交易物品`:""}`,"success"),U(!1)}catch(r){if(e!==g.current)return;console.error("Filter search error:",r),K("搜索失敗，請稍後再試","error"),X(!1),U(!1)}},[F,te,O,H,K,z,Z,We,me,pe,Ne,Ye]);return t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 via-purple-950/30 to-slate-950 text-white",children:[t.jsx(qr,{onSearch:er,isSearching:Z,searchText:tr,setSearchText:rt,isServerDataLoaded:ze,selectedDcName:O?.section,onItemSelect:pt,showNavigationButtons:!0,activePage:"advanced-search",onTaxRatesClick:rr,onAdvancedSearchClick:()=>{rt(""),xt("/advanced-search")},onMSQPriceCheckerClick:()=>{rt(""),xt("/msq-price-checker")},onUltimatePriceKingClick:()=>{rt(""),xt("/ultimate-price-king")}}),t.jsx("div",{className:"fixed right-2 mid:right-4 left-2 mid:left-auto z-50 space-y-2 max-w-sm mid:max-w-none top-[60px] mid:top-4",children:Qt.map(e=>t.jsx(Rr,{message:e.message,type:e.type,onClose:()=>Ot(e.id)},e.id))}),t.jsx("div",{className:"pt-24 pb-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-ffxiv-gold mb-2",children:"進階搜尋"}),t.jsx("p",{className:"text-gray-400 text-sm sm:text-base",children:"批量搜尋多個物品的市場價格，或使用篩選條件進行搜尋。"})]}),t.jsxs("div",{className:"mb-6 flex gap-2 border-b border-purple-500/30",children:[t.jsx("button",{onClick:()=>{bt("filter"),ir(""),De(null),Ge(1),He(999),jt(""),he(!1),ee([]),de([]),Re({}),Ee({}),Me({}),Le({}),ge({}),je(1),W.current&&W.current.abort(),X(!1)},className:`px-4 py-2 font-semibold transition-all border-b-2 ${Y==="filter"?"text-ffxiv-gold border-ffxiv-gold":"text-gray-400 border-transparent hover:text-gray-300"}`,children:"篩選搜尋"}),t.jsx("div",{className:"relative",title:"敬请期待",children:t.jsx("button",{onClick:()=>{},disabled:wt,className:"px-4 py-2 font-semibold transition-all border-b-2 text-gray-500 border-transparent cursor-not-allowed opacity-50",children:"批量搜尋（開發中）"})})]}),Y==="batch"&&!wt,Y==="filter"&&t.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4 sm:p-6 mb-6",children:[t.jsx("div",{className:"bg-slate-700/80 border border-slate-500/50 rounded-lg p-4 mb-6",children:t.jsx("p",{className:"text-sm text-gray-200 leading-relaxed",children:"這個頁面測試量過於龐大，作者個人時間有限。各位使用大大有發現bug歡迎參考主頁上的巴哈或dc方式回報，感激感激"})}),t.jsxs("div",{className:"mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6 items-stretch",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇職業"}),t.jsxs("div",{className:"space-y-[0.86821875rem]",children:[t.jsxs("div",{className:"flex flex-wrap gap-2",children:[ue.tank.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)}),ue.tank.length>0&&ue.healer.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ue.healer.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)})]}),t.jsxs("div",{className:"flex flex-wrap gap-2 pt-[0.5788125rem] border-t border-purple-500/10",children:[ue.melee.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)}),ue.melee.length>0&&ue.ranged.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ue.ranged.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-[0.5788125rem] border-t border-purple-500/10",children:[ue.caster.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:ue.caster.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)})}),t.jsx("div",{className:"flex flex-wrap gap-2",children:vr.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)})})]}),t.jsx("div",{className:"flex flex-wrap gap-2 pt-[0.5788125rem] border-t border-purple-500/20",children:wr.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Fe(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Ae.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Te(e.id)})},e.id)})})]}),F.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",F.length," 個職業"]})]}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇物品分類"}),t.jsxs("div",{className:"border border-purple-500/30 rounded-lg p-3 bg-slate-900/30 h-[290px] flex flex-col",children:[t.jsx("div",{className:"mb-3 flex-shrink-0",children:t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{ref:Pt,type:"text",value:$e,onChange:e=>Ct(e.target.value),placeholder:"篩選搜尋分類",className:"w-full pl-9 pr-3 py-2 bg-slate-800/60 backdrop-blur-sm border border-purple-500/20 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 transition-all text-xs"}),$e&&t.jsx("button",{onClick:()=>Ct(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors",title:"清除",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:t.jsxs("div",{className:"space-y-3",children:[[...D.weapons,...D.armor,...D.otherEquipment,...D.accessories].length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-ffxiv-gold mb-2 px-1",children:"裝備類"}),[...D.weapons,...D.armor,...D.otherEquipment].length>0&&t.jsx("div",{className:"grid grid-cols-4 gap-2 mb-2",children:[...D.weapons,...D.armor,...D.otherEquipment].map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),P=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${P?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})}),D.accessories.length>0&&t.jsx("div",{className:"grid grid-cols-4 gap-2",children:D.accessories.map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),P=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${P?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),[...D.weapons,...D.armor,...D.otherEquipment,...D.accessories].length>0&&D.miscellaneous.length>0&&t.jsx("div",{className:"border-t border-purple-500/30 my-2"}),D.miscellaneous.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-400 mb-2 px-1",children:"雜物類"}),t.jsx("div",{className:"grid grid-cols-4 gap-2",children:D.miscellaneous.map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),P=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${P?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),$e.trim()&&D.weapons.length===0&&D.armor.length===0&&D.accessories.length===0&&D.otherEquipment.length===0&&D.miscellaneous.length===0&&t.jsx("div",{className:"py-8 text-center",children:t.jsxs("div",{className:"text-sm text-gray-400",children:["沒有找到匹配「",$e,"」的分類"]})})]})})]}),te.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",te.length," 個分類"]}),t.jsx("div",{className:"mt-2 text-xs text-yellow-400"})]})]}),O&&t.jsxs("div",{className:"mb-6 flex flex-col lg:flex-row lg:justify-between gap-8 lg:gap-10",children:[t.jsxs("div",{className:"flex-shrink-0",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"裝備等級範圍"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{type:"number",min:"1",max:"999",value:gr&&me===1?"":me,onChange:e=>{const r=e.target.value;if(r===""){Ge(1);return}const P=parseInt(r);if(!isNaN(P)){const u=Math.max(1,Math.min(999,P));Ge(u),u>pe&&He(u)}},onFocus:()=>{Tt(!0)},onBlur:e=>{Tt(!1),(e.target.value===""||e.target.value==="1")&&Ge(1)},disabled:Se||z,placeholder:"1",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"}),t.jsx("div",{className:"text-gray-400",children:"~"}),t.jsx("input",{type:"number",min:"1",max:"999",value:mr&&pe===999?"":pe,onChange:e=>{const r=e.target.value;if(r===""){He(999);return}const P=parseInt(r);if(!isNaN(P)){const u=Math.max(1,Math.min(999,P));He(u),u<me&&Ge(u)}},onFocus:()=>{_t(!0)},onBlur:e=>{_t(!1),(e.target.value===""||e.target.value==="999")&&He(999)},disabled:Se||z,placeholder:"999",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"})]})]}),t.jsxs("div",{className:"w-full lg:w-auto lg:ml-auto",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"伺服器選擇"}),t.jsx(Er,{datacenters:Kt,worlds:mt,selectedWorld:O,onWorldChange:Zt,selectedServerOption:H,onServerOptionChange:Xt,serverOptions:Yt,disabled:Se||z})]})]}),Je&&t.jsx("div",{className:"mb-4 p-4 bg-yellow-900/40 border-2 border-yellow-500/50 rounded-lg",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"text-2xl",children:"⚠️"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-yellow-400 font-semibold mb-2",children:"找到的物品過多"}),t.jsxs("p",{className:"text-sm text-gray-300 mb-3",children:["找到 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Je.total})," 個可交易物品， 超過建議上限 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Je.limit})," 個。 處理過多物品可能會導致搜索時間過長或性能問題。"]}),t.jsxs("div",{className:"flex gap-2 flex-wrap",children:[t.jsx("button",{onClick:async()=>{const e=++g.current;W.current&&(W.current.abort(),W.current=null),J.current++,Ce.current=!1,ke(!1),X(!1),De(null),U(!0),et(!1),ee([]),de([]),he(!1),Re({}),Ee({}),Me({}),Le({}),ge({}),qt([]),et(!0),setTimeout(()=>{et(!1)},1500);try{const r=await Gt(!0);if(e!==g.current){U(!1);return}if(!r){U(!1);return}let{tradeableItemIds:P,untradeableItemIds:u}=r;if(e!==g.current){U(!1);return}const E=await Mt();if(e!==g.current){U(!1);return}St(E);const I=P.filter(c=>E.has(c)).slice(0,nt);K(`已限制為前 ${I.length} 個物品，正在獲取市場數據...`,"warning");const S=await at();if(e!==g.current){U(!1);return}const N=async(c,s)=>{if(e!==g.current)return;const l=S,o=[...s?c.filter(i=>E.has(i)):c].sort((i,d)=>{const f=l[i?.toString()]||null,b=l[d?.toString()]||null;return f!==null&&b!==null?b-f:f!==null?-1:b!==null?1:d-i}),M=20,$=o.slice(0,M),re=s?$.filter(i=>E.has(i)):$,ie=re.map(i=>{const f=gt[i?.toString()]?.tw||`物品 (ID: ${i})`;return{id:i,name:f,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((i,d)=>{const f=l[i.id?.toString()]||null,b=l[d.id?.toString()]||null;return f!==null&&b!==null?b-f:f!==null?-1:b!==null?1:d.id-i.id});if(s?(ee([]),he(!1),Qe.flushSync(()=>{ee(ie)}),(async()=>{const i=re.map(C=>Ke(C)),d=(await Promise.all(i)).filter(C=>C!==null);if(e!==g.current)return;const b=d.filter(C=>E.has(C.id)).sort((C,k)=>{const m=l[C.id?.toString()]||null,h=l[k.id?.toString()]||null;return m!==null&&h!==null?h-m:m!==null?-1:h!==null?1:k.id-C.id});e===g.current&&ee(b)})().catch(i=>{console.error("Error loading initial item details:",i)})):(de(ie),(async()=>{const i=$.map(b=>Ke(b)),d=(await Promise.all(i)).filter(b=>b!==null);if(e!==g.current)return;const f=d.sort((b,C)=>{const k=l[b.id?.toString()]||null,m=l[C.id?.toString()]||null;return k!==null&&m!==null?m-k:k!==null?-1:m!==null?1:C.id-b.id});e===g.current&&de(f)})().catch(i=>{console.error("Error loading untradeable item details:",i)})),O&&H&&o.length>0&&s){W.current&&W.current.abort();const i=++J.current;W.current=new AbortController;const d=W.current.signal;Ce.current=!0,ke(!0),X(!0),(async()=>{const f=H===O.section,b=f?O.section:H,C=(h,y,p)=>{const j=h?.world?.[p],R=y?.world?.[p],L=h?.dc?.[p],B=y?.dc?.[p],T=f?L!==void 0?L:j:j!==void 0?j:void 0,se=f?B!==void 0?B:R:R!==void 0?R:void 0;if(p==="quantity"){if(T!==void 0||se!==void 0)return(T||0)+(se||0)}else{if(T!==void 0&&se!==void 0)return Math.min(T,se);if(se!==void 0)return se;if(T!==void 0)return T}return null},k=async(h,y)=>{if(d.aborted||i!==J.current||e!==g.current)return;let p;h===0?p=20:h===1?p=50:p=100;const j=o.slice(y,y+p);if(j.length===0)return;const R=j.join(",");try{const L=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(b)}/${R}`,{signal:d});if(d.aborted||i!==J.current||e!==g.current)return;const B=await L.json();if(B&&B.results){const T={},se={},tt={},Ve={},w={};B.results.forEach(x=>{const we=x.itemId,oe=C(x.nq?.dailySaleVelocity,x.hq?.dailySaleVelocity,"quantity");let le=null;if(f)le=C(x.nq?.averageSalePrice,x.hq?.averageSalePrice,"price");else{const V=x.nq?.averageSalePrice?.world?.price,_=x.hq?.averageSalePrice?.world?.price,G=x.nq?.averageSalePrice?.dc?.price,ae=x.hq?.averageSalePrice?.dc?.price,ye=V!==void 0?V:G,ft=_!==void 0?_:ae;ye!==void 0&&ft!==void 0?le=Math.min(ye,ft):ft!==void 0?le=ft:ye!==void 0&&(le=ye)}const ve=C(x.nq?.minListing,x.hq?.minListing,"price"),ce=C(x.nq?.recentPurchase,x.hq?.recentPurchase,"price");let ne=null;if(ve!=null)if(f)ne=ve;else{const V=x.nq?.minListing?.world?.price,_=x.hq?.minListing?.world?.price;let G=null;if(V!==void 0&&_!==void 0?G=_<=V?x.hq?.minListing?.world:x.nq?.minListing?.world:_!==void 0?G=x.hq?.minListing?.world:V!==void 0&&(G=x.nq?.minListing?.world),G!==null){const ae=G?.region;ne={price:ve},ae!==void 0&&(ne.region=ae)}}let Q=null;if(ce!=null)if(f)Q=ce;else{const V=x.nq?.recentPurchase?.world?.price,_=x.hq?.recentPurchase?.world?.price;let G=null;V!==void 0&&_!==void 0?G=_<=V?x.hq?.recentPurchase?.world:x.nq?.recentPurchase?.world:_!==void 0?G=x.hq?.recentPurchase?.world:V!==void 0&&(G=x.nq?.recentPurchase?.world);const ae=G?.region;Q={price:ce},ae!==void 0&&(Q.region=ae)}oe!=null&&(T[we]=oe),le!=null&&(se[we]=Math.round(le)),ne!=null&&(tt[we]=ne),Q!=null&&(Ve[we]=Q),w[we]=!0}),j.forEach(x=>{w.hasOwnProperty(x)||(w[x]=!1)}),!d.aborted&&i===J.current&&e===g.current&&(Qe.flushSync(()=>{Re(x=>({...x,...T})),Ee(x=>({...x,...se})),Me(x=>({...x,...tt})),Le(x=>({...x,...Ve})),ge(x=>({...x,...w}))}),h===0&&X(!1))}}catch(L){if(L.name==="AbortError"||d.aborted)return;console.error("Error fetching market data:",L);const B={};j.forEach(T=>{B[T]=!1}),!d.aborted&&i===J.current&&e===g.current&&Qe.flushSync(()=>{ge(T=>({...T,...B}))})}},m=async(h,y)=>{if(d.aborted||i!==J.current||e!==g.current)return;if(y>=o.length){i===J.current&&e===g.current&&!d.aborted&&(X(!1),Ce.current=!1,ke(!1));return}if(await k(h,y),d.aborted||i!==J.current||e!==g.current)return;let p;h===0?p=20:h===1?p=50:p=100;const j=y+p;j<o.length?await new Promise(R=>{setTimeout(()=>{m(h+1,j).then(R)},h===0?0:100)}):i===J.current&&e===g.current&&!d.aborted&&(X(!1),Ce.current=!1,ke(!1))};try{await m(0,0)}catch(h){h.name!=="AbortError"&&console.error("Error in market data fetch:",h)}})().catch(f=>{f.name!=="AbortError"&&console.error("Error in market data fetch:",f)})}const be=50,v=async i=>{if(e!==g.current)return;const d=M+i*be;if(d>=o.length)return;const f=o.slice(d,d+be);if(f.length===0)return;const b=f.map(h=>Ke(h)),C=(await Promise.all(b)).filter(h=>h!==null);if(e!==g.current)return;const m=(s?C.filter(h=>E.has(h.id)):C).sort((h,y)=>{const p=S[h.id?.toString()]||null,j=S[y.id?.toString()]||null;return p!==null&&j!==null?j-p:p!==null?-1:j!==null?1:y.id-h.id});e===g.current&&(s?ee(h=>[...h,...m].sort((p,j)=>{const R=S[p.id?.toString()]||null,L=S[j.id?.toString()]||null;return R!==null&&L!==null?L-R:R!==null?-1:L!==null?1:j.id-p.id})):de(h=>[...h,...m].sort((p,j)=>{const R=S[p.id?.toString()]||null,L=S[j.id?.toString()]||null;return R!==null&&L!==null?L-R:R!==null?-1:L!==null?1:j.id-p.id})),await new Promise(h=>{setTimeout(()=>{v(i+1).then(h)},50)}))};o.length>M&&v(0).catch(i=>{console.error("Error loading remaining batches:",i)})};if(I.length>0?(he(!1),N(I,!0).catch(c=>{console.error("Error loading tradeable items progressively:",c)}),u.length>0&&N(u,!1).catch(c=>{console.error("Error loading untradeable items:",c)})):u.length>0&&N(u,!1).catch(c=>{console.error("Error loading untradeable items:",c)}),e!==g.current){U(!1);return}(I.length>0||u.length>0)&&K(`找到 ${I.length} 個可交易物品${u.length>0?`、${u.length} 個不可交易物品`:""}`,"success"),U(!1)}catch(r){if(e!==g.current)return;console.error("Continue search error:",r),K("搜索失敗，請稍後再試","error"),X(!1),U(!1)}},className:"confirm-button-attention py-3",children:t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx("span",{children:"確認"}),t.jsxs("span",{children:["繼續搜索（限制為前 ",nt," 個）"]})]})}),t.jsx("button",{onClick:()=>De(null),className:"px-4 py-2 bg-slate-700/50 border border-gray-500/50 rounded-lg text-gray-300 hover:bg-slate-700/70 transition-all text-sm font-medium",children:"取消"})]})]})]})}),t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("div",{className:"w-[40%] relative",children:[t.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{type:"text",value:We,onChange:e=>jt(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!z&&!Z&&(F.length>0||te.length>0)&&!Je&&Ht()},placeholder:"物品名篩選（多關鍵詞用空格分隔）",disabled:z||Z,className:`w-full py-3 pl-10 pr-20 rounded-lg bg-slate-900/90 backdrop-blur-sm border text-white placeholder-gray-400 focus:outline-none focus:ring-1 transition-all text-sm shadow-lg ${z||Z?"border-slate-700/30 cursor-not-allowed opacity-60":"border-purple-500/40 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 shadow-purple-500/20"}`}),t.jsxs("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-10 flex items-center gap-1.5",children:[t.jsxs("label",{className:"flex items-center cursor-pointer group",title:Ne?"開啟精準搜尋":"關閉精準搜尋",children:[t.jsx("input",{type:"checkbox",checked:!Ne,onChange:e=>pr(!e.target.checked),disabled:z||Z,className:"sr-only"}),t.jsx("div",{className:`relative w-9 h-5 rounded-full transition-colors duration-200 ${z||Z?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${Ne?"bg-slate-600/60":"bg-ffxiv-gold/80"}`,children:t.jsx("div",{className:`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-200 ${Ne?"translate-x-0":"translate-x-4"}`})})]}),t.jsx("span",{className:`text-xs whitespace-nowrap select-none ${z||Z?"text-gray-500":Ne?"text-gray-400":"text-ffxiv-gold"}`,children:"精準"})]})]}),t.jsx("button",{onClick:Ht,disabled:z||Z||Ye||F.length===0&&te.length===0||Je!==null,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${z||Z||Ye||F.length===0&&te.length===0||Je!==null?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-gradient-to-r from-ffxiv-gold to-yellow-500 text-slate-900 hover:shadow-[0_0_20px_rgba(212,175,55,0.5)]"}`,children:z||Z?"搜索中...":"搜索"}),t.jsx("button",{onClick:()=>{$t([]),Bt([]),Ge(1),He(999),jt(""),ee([]),de([]),he(!1),Re({}),Ee({}),Me({}),Le({}),ge({}),je(1),De(null),W.current&&W.current.abort(),X(!1),U(!1)},disabled:z||Z,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${z||Z?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-red-600/60 text-white border border-red-500/50 hover:bg-red-600/80 hover:border-red-400/70 hover:shadow-[0_0_20px_rgba(220,38,38,0.5)]"}`,children:"清空篩選"})]})]}),(()=>{const e=Ie.length>0;if(!(Y==="filter"?e||!e&&qe.length>0:Y==="batch"&&!wt))return null;const u=Y==="filter"?Ue?qe:Ie:[],E=(()=>{if(!xe)return{};const l={};return u.forEach(n=>{const o=xe[n.id?.toString()]!==void 0?xe[n.id.toString()]:0;l[o]=(l[o]||0)+1}),l})();let q=u,I=q;if(At&&q.some(n=>It?.[n.id]===!0)&&(I=q.filter(n=>It?.[n.id]===!0)),ot.length>0&&xe){const l=ot[0];q=q.filter(n=>(xe[n.id?.toString()]!==void 0?xe[n.id.toString()]:0)===l),I=I.filter(n=>(xe[n.id?.toString()]!==void 0?xe[n.id.toString()]:0)===l)}const S=Math.ceil(q.length/Be),N=(A-1)*Be,c=N+Be,s=q.slice(N,c);return t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[t.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-ffxiv-gold",children:["搜索結果 (",q.length," 個物品",I.length!==q.length?`，顯示 ${I.length} 個`:"",")"]}),O&&H&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-900/40 via-pink-900/30 to-indigo-900/40 border border-purple-500/30 rounded-lg backdrop-blur-sm",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-ffxiv-gold animate-pulse"}),t.jsx("span",{className:"text-xs sm:text-sm font-semibold text-ffxiv-gold",children:H===O.section?`${O.section} (全服)`:mt[H]||`伺服器 ${H}`})]}),Y==="filter"&&qe.length>0&&ze&&!Se&&!st&&!Nt&&!z&&t.jsx("button",{onClick:()=>{he(!Ue),je(1)},className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all duration-200 backdrop-blur-sm shadow-sm ${Ue?"bg-gradient-to-r from-slate-700/70 via-slate-600/60 to-slate-700/70 text-gray-200 border border-slate-500/50 hover:from-slate-600/80 hover:via-slate-500/70 hover:to-slate-600/80 hover:border-slate-400/60 hover:shadow-md":"bg-gradient-to-r from-slate-800/70 via-slate-700/60 to-slate-800/70 text-gray-300 border border-slate-600/50 hover:from-slate-700/80 hover:via-slate-600/70 hover:to-slate-700/80 hover:border-slate-500/60 hover:shadow-md hover:text-gray-200"}`,children:Ue?"隱藏不可交易物品":`顯示不可以交易物品${qe.length}個`}),xr&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-slate-800/50 border border-purple-500/30 rounded-lg",children:[t.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-ffxiv-gold"}),t.jsx("span",{className:"text-xs text-gray-300",children:"載入中..."})]})]}),q.length>Be&&t.jsxs("div",{className:"mb-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:Be,onChange:l=>{const n=parseInt(l.target.value,10);Ft(n),je(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",N+1,"-",Math.min(c,q.length)," / ",q.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Pe(1),disabled:A===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Pe(A-1),disabled:A===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",A," / ",S," 頁"]}),t.jsx("button",{onClick:()=>Pe(A+1),disabled:A===S,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===S?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Pe(S),disabled:A===S,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===S?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]}),t.jsx(Mr,{items:s,onSelect:l=>{if(pt){const n=new URLSearchParams;H&&n.set("server",H);const o=n.toString(),M=`/item/${l.id}${o?"?"+o:""}`;pt(l),window.open(M,"_blank")}},selectedItem:null,marketableItems:At,itemVelocities:or,itemAveragePrices:cr,itemMinListings:dr,itemRecentPurchases:ur,itemTradability:It,isLoadingVelocities:Se,averagePriceHeader:"平均價格",getSimplifiedChineseName:Br,addToast:K,selectedRarities:ot,setSelectedRarities:qt,raritiesData:xe,externalRarityFilter:!0,externalRarityCounts:E,isServerDataLoaded:ze,isRaritySelectorDisabled:!ze||Se||st||Nt||z}),q.length>Be&&t.jsxs("div",{className:"mt-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:Be,onChange:l=>{const n=parseInt(l.target.value,10);Ft(n),je(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",N+1,"-",Math.min(c,q.length)," / ",q.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Pe(1),disabled:A===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Pe(A-1),disabled:A===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",A," / ",S," 頁"]}),t.jsx("button",{onClick:()=>Pe(A+1),disabled:A===S,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===S?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Pe(S),disabled:A===S,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${A===S?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]})]})})()]})}),t.jsx(Lr,{isOpen:nr,onClose:()=>sr(!1),taxRates:lr,worlds:mt,isLoading:ar,selectedWorld:O,selectedServerOption:H})]})}export{Kr as default};

import{_ as ke,g as ss,T as ts,a as rs,S as as,I as ns,b as is}from"./index-D0qHnoCy.js";import{u as ls,b as os,a as cs,r as t,j as s}from"./react-vendor-DmEpS5Kz.js";import{g as ds,b as us}from"./services-data-Bkm-MtE8.js";import{a as fs}from"./axios-B9ygI19o.js";import"./vendor-dPMYpV4t.js";import"./opencc-C1Qz6KEM.js";import"./teamcraft-data-u2h6--oi.js";const ie={1:{MainHand:1,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},2:{MainHand:0,OffHand:1,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},3:{MainHand:0,OffHand:0,Head:1,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},4:{MainHand:0,OffHand:0,Head:0,Body:1,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},5:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:1,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},6:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:1,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},7:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:1,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},8:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:1,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},9:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:1,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},10:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:1,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},11:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:1,FingerL:0,FingerR:0,SoulCrystal:0},12:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:1,FingerR:1,SoulCrystal:0},13:{MainHand:1,OffHand:-1,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},14:{MainHand:1,OffHand:1,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},15:{MainHand:0,OffHand:0,Head:-1,Body:1,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},16:{MainHand:0,OffHand:0,Head:0,Body:1,Gloves:-1,Waist:0,Legs:-1,Feet:-1,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},17:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:1},18:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:1,Feet:-1,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},19:{MainHand:0,OffHand:0,Head:-1,Body:1,Gloves:-1,Waist:0,Legs:-1,Feet:-1,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},20:{MainHand:0,OffHand:0,Head:0,Body:1,Gloves:-1,Waist:0,Legs:-1,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},21:{MainHand:0,OffHand:0,Head:0,Body:1,Gloves:0,Waist:0,Legs:-1,Feet:-1,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},22:{MainHand:0,OffHand:0,Head:0,Body:1,Gloves:-1,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},23:{MainHand:0,OffHand:0,Head:0,Body:1,Gloves:0,Waist:0,Legs:-1,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0},24:{MainHand:0,OffHand:0,Head:0,Body:0,Gloves:0,Waist:0,Legs:0,Feet:0,Ears:0,Neck:0,Wrists:0,FingerL:0,FingerR:0,SoulCrystal:0}},gs={MainHand:"主手武器",OffHand:"副手",Head:"頭部",Body:"身體",Gloves:"手套",Waist:"腰部",Legs:"腿部",Feet:"腳部",Ears:"耳環",Neck:"項鍊",Wrists:"手環",Rings:"戒指"};function Fs({addToast:x,removeToast:qe,toasts:We,datacenters:Pe,worlds:J,selectedWorld:m,onWorldChange:Ee,selectedServerOption:g,onServerOptionChange:we,serverOptions:Ie,isServerDataLoaded:W,onItemSelect:X,onSearch:je,searchText:Me,setSearchText:B,isSearching:P,onTaxRatesClick:Be,isTaxRatesModalOpen:Oe,setIsTaxRatesModalOpen:Ge,taxRates:_e,isLoadingTaxRates:Ve}){const E=ls(),[F,Ae]=os(),O=cs(),[v,le]=t.useState(""),[y,w]=t.useState(null),I=t.useRef(null),G=t.useRef(!1),Y=t.useRef(""),[H,_]=t.useState(null),[Z,ee]=t.useState([]),[$e,oe]=t.useState({}),[De,ce]=t.useState({}),[Te,de]=t.useState({}),[Ue,ue]=t.useState({}),[ze,fe]=t.useState({}),[ge,V]=t.useState(!1),[Qe,Ke]=t.useState(null),A=t.useRef(null),$=t.useRef(null),me=t.useCallback(async()=>{if($.current)return $.current;const e=await ke(()=>import("./equipment-sIOEhpr0.js"),[]);return $.current=e.default,$.current},[]),L=t.useCallback(async()=>{if(A.current)return A.current;const e=await ke(()=>import("./ilvls-Bj6OKdVo.js"),[]);return A.current=e.default,A.current},[]);t.useEffect(()=>{if(G.current)return;const e=`${O.pathname}?${O.search}`;if(Y.current===e)return;const n=F.get("ilvl"),c=F.get("category");if(n){const o=parseInt(n,10);!isNaN(o)&&o>=1&&o<=999&&(G.current=!0,le(n),L().then(r=>{const a=Object.entries(r).filter(([u,T])=>T===o);a.length>0&&w({valid:!0,message:`找到 ${a.length} 個物品`})}),_(c||null),Y.current=e)}else Y.current=e},[O.pathname,O.search,F,L]);const[ve,pe]=t.useState(!1),D=t.useRef(null);t.useEffect(()=>{const e=F.get("ilvl");e&&G.current&&v===e&&y?.valid&&W&&(G.current=!1,pe(!0))},[v,y,F,W]),t.useEffect(()=>{ve&&v&&y?.valid&&W&&D.current&&(pe(!1),setTimeout(()=>{D.current&&D.current()},100))},[ve,v,y,W]);const se=t.useMemo(()=>{const e=new Map;Object.entries(ie).forEach(([c,o])=>{Object.entries(o).forEach(([r,a])=>{if(r!=="SoulCrystal"&&(a===1||a===-1)){const u=r==="FingerL"||r==="FingerR"?"Rings":r;e.has(u)||e.set(u,{name:u,translatedName:gs[u]||u})}})});const n=["MainHand","OffHand","Head","Body","Gloves","Legs","Feet","Ears","Neck","Wrists","Rings"];return Array.from(e.values()).sort((c,o)=>{const r=n.indexOf(c.name),a=n.indexOf(o.name);return r===-1?1:a===-1?-1:r-a})},[]),he=t.useCallback((e,n,c)=>{if(!n)return!0;const o=c[e.toString()];if(!o||o.equipSlotCategory===void 0)return!1;const r=o.equipSlotCategory,a=ie[r.toString()];return a?n==="Rings"?a.FingerL===1||a.FingerL===-1||a.FingerR===1||a.FingerR===-1:n==="SoulCrystal"?!1:a[n]===1||a[n]===-1:!1},[]),xe=t.useCallback((e,n)=>{const c=n[e.toString()];if(!c||c.equipSlotCategory===void 0)return!1;const o=c.equipSlotCategory,r=ie[o.toString()];return r?se.some(a=>a.name==="Rings"?r.FingerL===1||r.FingerL===-1||r.FingerR===1||r.FingerR===-1:a.name==="SoulCrystal"?!1:r[a.name]===1||r[a.name]===-1):!1},[se]),Je=t.useCallback(e=>{le(e),I.current&&clearTimeout(I.current),I.current=setTimeout(async()=>{const n=parseInt(e,10);if(e===""){w(null);return}if(isNaN(n)||n<1||n>999){w({valid:!1,message:"請輸入1-999之間的數字"});return}const c=await L(),o=Object.entries(c).filter(([r,a])=>a===n);o.length===0?w({valid:!1,message:"此物品等級沒有物品"}):w({valid:!0,message:`找到 ${o.length} 個物品`})},1e3)},[L]);t.useEffect(()=>()=>{I.current&&clearTimeout(I.current)},[]);const te=t.useCallback(async()=>{if(P)return;const e=parseInt(v,10);if(isNaN(e)||e<1||e>999){x("請輸入有效的物品等級","error");return}const n=F.get("ilvl"),c=F.get("category");if(n!==v||c!==(H||"")){const r=new URLSearchParams;r.set("ilvl",v),H?r.set("category",H):r.delete("category"),E(`/msq-price-checker?${r.toString()}`,{replace:!0})}ee([]),oe({}),ce({}),de({}),ue({}),fe({});try{const[r,a]=await Promise.all([L(),me()]);let u=Object.entries(r).filter(([i,f])=>f===e).map(([i,f])=>parseInt(i,10));if(u.length===0){x("未找到該物品等級的物品","warning"),ee([]);return}if(H?u=u.filter(i=>he(i,H,a)):u=u.filter(i=>xe(i,a)),u.length===0){x("該裝備分類中沒有相符的物品","warning");return}const T=await ss();Ke(T);const U=u.filter(i=>T.has(i));if(U.length===0){x("沒有可交易的物品","warning");return}const Xe=U.map(i=>ds(i)),ye=(await Promise.all(Xe)).filter(i=>i!==null);if(ye.length===0){x("無法獲取物品信息","error");return}const Ye=ye.map(i=>{const f=a[i.id.toString()];return{...i,ilvl品級:e,需求等級:f?.level||0,equipSlotCategory:f?.equipSlotCategory,jobs:f?.jobs||[]}}).sort((i,f)=>i.需求等級!==f.需求等級?i.需求等級-f.需求等級:i.name.localeCompare(f.name));if(ee(Ye),V(!0),!m||!g){x("請選擇伺服器","warning"),V(!1);return}const j=g===m.section,Ze=j?m.section:g,be=100,Fe={},He={},Le={},Ne={},N={};for(let i=0;i<U.length;i+=be){const f=U.slice(i,i+be),es=f.join(",");try{const S=(await fs.get(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(Ze)}/${es}`)).data;S&&S.results&&S.results.forEach(l=>{const M=l.itemId,z=(p,h,d)=>{const b=p?.world?.[d],ne=h?.world?.[d],Re=p?.dc?.[d],Ce=h?.dc?.[d],k=j?Re!==void 0?Re:b:b!==void 0?b:void 0,q=j?Ce!==void 0?Ce:ne:ne!==void 0?ne:void 0;if(d==="quantity"){if(k!==void 0||q!==void 0)return(k||0)+(q||0)}else{if(k!==void 0&&q!==void 0)return Math.min(k,q);if(q!==void 0)return q;if(k!==void 0)return k}return null},re=z(l.nq?.dailySaleVelocity,l.hq?.dailySaleVelocity,"quantity"),ae=z(l.nq?.averageSalePrice,l.hq?.averageSalePrice,"price"),Q=z(l.nq?.minListing,l.hq?.minListing,"price"),K=z(l.nq?.recentPurchase,l.hq?.recentPurchase,"price");let R=null;if(Q!=null)if(j)R=Q;else{const p=l.nq?.minListing?.world?.price,h=l.hq?.minListing?.world?.price;let d=null;p!==void 0&&h!==void 0?d=h<=p?l.hq?.minListing?.world:l.nq?.minListing?.world:h!==void 0?d=l.hq?.minListing?.world:p!==void 0&&(d=l.nq?.minListing?.world);const b=d?.region;R={price:Q},b!==void 0&&(R.region=b)}let C=null;if(K!=null)if(j)C=K;else{const p=l.nq?.recentPurchase?.world?.price,h=l.hq?.recentPurchase?.world?.price;let d=null;p!==void 0&&h!==void 0?d=h<=p?l.hq?.recentPurchase?.world:l.nq?.recentPurchase?.world:h!==void 0?d=l.hq?.recentPurchase?.world:p!==void 0&&(d=l.nq?.recentPurchase?.world);const b=d?.region;C={price:K},b!==void 0&&(C.region=b)}re!=null&&(Fe[M]=re),ae!=null&&(He[M]=Math.round(ae)),R!=null&&(Le[M]=R),C!=null&&(Ne[M]=C),N[M]=!0}),f.forEach(l=>{N.hasOwnProperty(l)||(N[l]=!1)})}catch(Se){console.error("Error fetching market data:",Se),f.forEach(S=>{N.hasOwnProperty(S)||(N[S]=!1)})}}oe(Fe),ce(He),de(Le),ue(Ne),fe(N),V(!1)}catch(r){console.error("Search error:",r),x("搜索失敗，請稍後再試","error"),V(!1)}},[v,H,m,g,x,he,xe,F,Ae,L,me]);return t.useEffect(()=>{D.current=te},[te]),s.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 via-purple-950/30 to-slate-950 text-white",children:[s.jsx(ts,{onSearch:je,isSearching:P,searchText:Me,setSearchText:B,isServerDataLoaded:W,selectedDcName:m?.section,onItemSelect:X,showNavigationButtons:!0,activePage:"msq-price-checker",onTaxRatesClick:Be,onMSQPriceCheckerClick:()=>{B(""),E("/msq-price-checker")},onUltimatePriceKingClick:()=>{B(""),E("/ultimate-price-king")},onAdvancedSearchClick:()=>{B(""),E("/advanced-search")}}),s.jsx("div",{className:"fixed right-2 mid:right-4 left-2 mid:left-auto z-50 space-y-2 max-w-sm mid:max-w-none top-[60px] mid:top-4",children:We.map(e=>s.jsx(rs,{message:e.message,type:e.type,onClose:()=>qe(e.id)},e.id))}),s.jsx("div",{className:"pt-24 pb-8",children:s.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-ffxiv-gold mb-2",children:"主線裝備查價"}),s.jsx("p",{className:"text-gray-400 text-sm sm:text-base",children:"主線拿到的箱子可以快速查看市場價格。"})]}),s.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4 sm:p-6 mb-6",children:[s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"物品等級 (ilvl品級)"}),s.jsx("div",{className:"flex items-end gap-3",children:s.jsxs("div",{className:"flex-1",children:[s.jsx("input",{type:"number",inputMode:"numeric",value:v,onChange:e=>Je(e.target.value),placeholder:"輸入物品等級...",className:"w-full px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold",min:"1",max:"999"}),y&&s.jsx("div",{className:`mt-2 text-xs ${y.valid?"text-green-400":"text-yellow-400"}`,children:y.message})]})})]}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"裝備分類 (可選)"}),s.jsxs("div",{className:"flex flex-wrap gap-2 max-h-48 overflow-y-auto p-2 bg-slate-900/30 rounded-lg border border-purple-500/20",children:[s.jsx("button",{onClick:()=>_(null),className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all ${H===null?"bg-ffxiv-gold text-slate-900 border-2 border-ffxiv-gold":"bg-slate-800/50 text-gray-300 border border-purple-500/30 hover:bg-purple-800/40 hover:border-purple-400/50"}`,children:"全部分類"}),se.map(e=>{const n=H===e.name;return s.jsx("button",{onClick:()=>_(e.name),className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all ${n?"bg-ffxiv-gold text-slate-900 border-2 border-ffxiv-gold":"bg-slate-800/50 text-gray-300 border border-purple-500/30 hover:bg-purple-800/40 hover:border-purple-400/50"}`,children:e.translatedName},e.name)})]})]}),m&&s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"伺服器選擇"}),s.jsx(as,{datacenters:Pe,worlds:J,selectedWorld:m,onWorldChange:Ee,selectedServerOption:g,onServerOptionChange:we,serverOptions:Ie,disabled:ge})]}),s.jsx("button",{onClick:te,disabled:P||!v||!y?.valid,className:`w-full py-3 rounded-lg font-semibold transition-all ${P||!v||!y?.valid?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-gradient-to-r from-ffxiv-gold to-yellow-500 text-slate-900 hover:shadow-[0_0_20px_rgba(212,175,55,0.5)]"}`,children:P?"搜索中...":"搜索"})]}),Z.length>0&&s.jsxs("div",{className:"mb-6",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[s.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-ffxiv-gold",children:["搜索結果 (",Z.length," 個物品)"]}),m&&g&&s.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-900/40 via-pink-900/30 to-indigo-900/40 border border-purple-500/30 rounded-lg backdrop-blur-sm",children:[s.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-ffxiv-gold animate-pulse"}),s.jsx("span",{className:"text-xs sm:text-sm font-semibold text-ffxiv-gold",children:g===m.section?`${m.section} (全服)`:J[g]||`伺服器 ${g}`})]})]}),s.jsx(ns,{items:Z,onSelect:e=>{if(X){const n=new URLSearchParams;g&&n.set("server",g);const c=n.toString(),o=`/item/${e.id}${c?"?"+c:""}`;X(e),requestAnimationFrame(()=>{requestAnimationFrame(()=>{E(o,{replace:!0})})})}},selectedItem:null,marketableItems:Qe,itemVelocities:$e,itemAveragePrices:De,itemMinListings:Te,itemRecentPurchases:Ue,itemTradability:ze,isLoadingVelocities:ge,averagePriceHeader:"平均價格",getSimplifiedChineseName:us,addToast:x})]})]})}),s.jsx(is,{isOpen:Oe,onClose:()=>Ge(!1),taxRates:_e,worlds:J,isLoading:Ve,selectedWorld:m,selectedServerOption:g})]})}export{Fs as default};

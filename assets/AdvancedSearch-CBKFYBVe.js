import{_ as dt,g as Nt,T as vr,a as yr,S as Ir,I as Sr}from"./index-BMVmCkAK.js";import{u as Nr,b as jr,a as Cr,r as a,d as He,j as t}from"./react-vendor-DmEpS5Kz.js";import{l as Ft,g as We,b as Pr}from"./services-data-ht0PYgmz.js";import{t as kr}from"./tw-job-abbr-xwaoke-z.js";import{a as ut}from"./teamcraft-data-u2h6--oi.js";import"./axios-B9ygI19o.js";import"./vendor-dPMYpV4t.js";import"./opencc-C1Qz6KEM.js";const qr={1:{tw:"格鬥武器"},2:{tw:"單手劍"},3:{tw:"大斧"},4:{tw:"弓"},5:{tw:"長槍"},6:{tw:"單手咒杖"},7:{tw:"雙手咒杖"},8:{tw:"單手幻杖"},9:{tw:"雙手幻杖"},10:{tw:"魔導書"},11:{tw:"盾"},12:{tw:"木工工具（主工具）"},13:{tw:"木工工具（副工具）"},14:{tw:"鍛造工具（主工具）"},15:{tw:"鍛造工具（副工具）"},16:{tw:"甲冑工具（主工具）"},17:{tw:"甲冑工具（副工具）"},18:{tw:"金工工具（主工具）"},19:{tw:"金工工具（副工具）"},20:{tw:"皮革工具（主工具）"},21:{tw:"皮革工具（副工具）"},22:{tw:"裁縫工具（主工具）"},23:{tw:"裁縫工具（副工具）"},24:{tw:"鍊金工具（主工具）"},25:{tw:"鍊金工具（副工具）"},26:{tw:"烹調工具（主工具）"},27:{tw:"烹調工具（副工具）"},28:{tw:"採掘工具（主工具）"},29:{tw:"採掘工具（副工具）"},30:{tw:"園藝工具（主工具）"},31:{tw:"園藝工具（副工具）"},32:{tw:"捕魚用具（主工具）"},33:{tw:"釣餌"},34:{tw:"頭部防具"},35:{tw:"身體防具"},36:{tw:"腿部防具"},37:{tw:"手部防具"},38:{tw:"腳部防具"},39:{tw:"停止流通道具"},40:{tw:"項鍊"},41:{tw:"耳飾"},42:{tw:"手鐲"},43:{tw:"戒指"},44:{tw:"藥品"},45:{tw:"食材"},46:{tw:"食品"},47:{tw:"水產品"},48:{tw:"石材"},49:{tw:"金屬"},50:{tw:"木材"},51:{tw:"布料"},52:{tw:"皮革"},53:{tw:"骨材"},54:{tw:"鍊金原料"},55:{tw:"染料"},56:{tw:"組件"},57:{tw:"傢俱"},58:{tw:"魔晶石"},59:{tw:"水晶"},60:{tw:"觸媒"},61:{tw:"雜貨"},62:{tw:"靈魂水晶"},63:{tw:"其他"},64:{tw:"房產證書"},65:{tw:"房頂"},66:{tw:"外牆"},67:{tw:"窗戶"},68:{tw:"房門"},69:{tw:"房頂裝飾"},70:{tw:"外牆裝飾"},71:{tw:"門牌"},72:{tw:"院牆"},73:{tw:"內牆"},74:{tw:"地板"},75:{tw:"屋頂照明"},76:{tw:"庭具"},77:{tw:"桌台"},78:{tw:"桌上"},79:{tw:"壁掛"},80:{tw:"地毯"},81:{tw:"寵物"},82:{tw:"栽培用品"},83:{tw:"半魔晶石"},84:{tw:"雙劍"},85:{tw:"雜貨（季節活動）"},86:{tw:"九宮幻卡"},87:{tw:"雙手劍"},88:{tw:"火槍"},89:{tw:"天球儀"},90:{tw:"飛空艇組件（船體）"},91:{tw:"飛空艇組件（艤裝）"},92:{tw:"飛空艇組件（船尾）"},93:{tw:"飛空艇組件（船首）"},94:{tw:"管弦樂琴樂譜"},95:{tw:"繪畫作品"},96:{tw:"武士刀"},97:{tw:"刺劍"},98:{tw:"魔導書（學者專用）"},99:{tw:"捕魚用具（副工具）"},100:{tw:"貨幣"},101:{tw:"潛水艇組件（船體）"},102:{tw:"潛水艇組件（船尾）"},103:{tw:"潛水艇組件（船首）"},104:{tw:"潛水艇組件（艦橋）"},105:{tw:"青魔杖"},106:{tw:"槍刃"},107:{tw:"投擲武器"},108:{tw:"雙手鐮刀"},109:{tw:"賢具"},110:{tw:"二刀流武器"},111:{tw:"筆"},112:{tw:"套裝"}};function Fr({addToast:Q,removeToast:Vt,toasts:Ut,datacenters:zt,worlds:jt,selectedWorld:O,onWorldChange:Jt,selectedServerOption:H,onServerOptionChange:Gt,serverOptions:Ht,isServerDataLoaded:Oe,onItemSelect:ft,onSearch:Wt,searchText:Ot,setSearchText:Ye,isSearching:K}){const gt=Nr(),[Ct]=jr(),Qe=Cr(),[Y,ht]=a.useState("filter"),mt=!0,[Pt,Qt]=a.useState(""),[ye,ee]=a.useState([]),[Ie,Z]=a.useState([]),[Te,de]=a.useState(!1),pt=a.useRef(!1),xt=a.useRef(""),[Kt,ke]=a.useState({}),[Zt,qe]=a.useState({}),[Xt,Re]=a.useState({}),[Yt,Ee]=a.useState({}),[er,ge]=a.useState({}),[he,X]=a.useState(!1),[tr,bt]=a.useState(null),[kt,Rr]=a.useState(!1),[Fe,Me]=a.useState(null),et=500,[rr,Er]=a.useState(!0),[T,qt]=a.useState([]),[te,Rt]=a.useState([]),[J,V]=a.useState(!1),[Le,nr]=a.useState(new Set),[me,Ve]=a.useState(1),[pe,Ue]=a.useState(999),[lr,Et]=a.useState(!1),[sr,Mt]=a.useState(!1),[ze,wt]=a.useState(""),[Se,ir]=a.useState(!0),vt=[62],[D,Ne]=a.useState(1),[De,Lt]=a.useState(50),[ar,Ke]=a.useState(!1),Je=a.useRef(null),Ae=a.useCallback(e=>{nr(n=>new Set(n).add(e))},[]),G=a.useRef(null),U=a.useRef(0),je=a.useRef(!1),[or,Ce]=a.useState(!1),f=a.useRef(0);a.useRef(0);const[Ge,tt]=a.useState(!1),rt=a.useRef(null),nt=a.useCallback(async()=>{if(rt.current)return rt.current;const e=await dt(()=>import("./ilvls-Bj6OKdVo.js"),[]);return rt.current=e.default,rt.current},[]),lt=a.useRef(null),[$e,cr]=a.useState(null),[st,yt]=a.useState([]),Dt=a.useCallback(async()=>{if(lt.current)return lt.current;const e=await dt(()=>import("./rarities-CrVnX0d9.js"),[]);return lt.current=e.default,lt.current},[]);a.useEffect(()=>{Dt().then(e=>{cr(e)})},[Dt]),a.useEffect(()=>{Ne(1)},[st]);const it=a.useRef(null),at=a.useCallback(async()=>{if(it.current)return it.current;const e=await dt(()=>import("./equipment-sIOEhpr0.js"),[]);return it.current=e.default,it.current},[]),ot=a.useRef(null),At=a.useCallback(async()=>{if(ot.current)return ot.current;const e=await dt(()=>import("./ui-categories-B7UiuPPW.js"),[]);return ot.current=e.default,ot.current},[]),It=a.useCallback(e=>({1:"GLA",2:"PGL",3:"MRD",4:"LNC",5:"ARC",6:"CNJ",7:"THM",8:"CRP",9:"BSM",10:"ARM",11:"GSM",12:"LTW",13:"WVR",14:"ALC",15:"CUL",16:"MIN",17:"BTN",18:"FSH",19:"PLD",20:"MNK",21:"WAR",22:"DRG",23:"BRD",24:"WHM",25:"BLM",26:"ACN",27:"SMN",28:"SCH",29:"ROG",30:"NIN",31:"MCH",32:"DRK",33:"AST",34:"SAM",35:"RDM",36:"BLU",37:"GNB",38:"DNC",39:"RPR",40:"SGE",41:"VPR",42:"PCT"})[e],[]);a.useCallback(async(e=null)=>{{Q("批量搜索功能暂时不可用，敬请期待","info");return}},[Pt,O,H,Q,Ge,rr]),a.useEffect(()=>{if(!Oe)return;const e=`${Qe.pathname}?${Qe.search}`;if(xt.current===e)return;if(Qe.pathname!=="/advanced-search"){xt.current=e;return}const n=Ct.get("q");n&&n.trim()!==""?(Y==="batch"&&ht("filter"),pt.current=!1):(pt.current&&ye.length>0&&(ee([]),ke({}),qe({}),Re({}),Ee({}),ge({}),Ne(1)),pt.current=!1),xt.current=e},[Qe.pathname,Qe.search,Ct,Oe,Pt,Y,ye.length,kt,J,K]),a.useEffect(()=>{Y==="batch"&&ht("filter")},[Y]),a.useEffect(()=>{if(he&&((Y==="filter"&&Te?Ie:ye).length>=50||ye.length>=50||Ie.length>=50))Je.current||(Je.current=Date.now()),Ke(!0);else if(Je.current){const k=Date.now()-Je.current,m=Math.max(0,1e3-k);if(m>0){const R=setTimeout(()=>{Ke(!1),Je.current=null},m);return()=>clearTimeout(R)}else Ke(!1),Je.current=null}else Ke(!1)},[he,Te,ye.length,Ie.length,Y]);const{craftingJobs:dr,gatheringJobs:ur,battleJobsByRole:ue}=a.useMemo(()=>{const e=new Set([1,2,3,4,5,6,7,26,29]),n={19:"paladin",20:"monk",21:"warrior",22:"dragoon",23:"bard",24:"whitemage",25:"blackmage",27:"summoner",28:"scholar",30:"ninja",31:"machinist",32:"darkknight",33:"astrologian",34:"samurai",35:"redmage",36:"bluemage",37:"gunbreaker",38:"dancer",39:"reaper",40:"sage",41:"viper",42:"pictomancer",8:"carpenter",9:"blacksmith",10:"armorer",11:"goldsmith",12:"leatherworker",13:"weaver",14:"alchemist",15:"culinarian",16:"miner",17:"botanist",18:"fisher"},k={19:"tank",21:"tank",32:"tank",37:"tank",24:"healer",28:"healer",33:"healer",40:"healer",20:"melee",22:"melee",30:"melee",34:"melee",39:"melee",41:"melee",23:"ranged",31:"ranged",38:"ranged",25:"caster",27:"caster",35:"caster",36:"caster",42:"caster"},m=[],R=[],C={tank:[],healer:[],melee:[],ranged:[],caster:[]};return Object.entries(kr).forEach(([g,E])=>{const P=parseInt(g,10);if(e.has(P))return;const d=n[P];if(!d)return;const r={id:P,name:E.tw,iconUrl:`https://xivapi.com/cj/companion/${d}.png`};if(P>=8&&P<=15)m.push(r);else if(P>=16&&P<=18)R.push(r);else if(P>=19&&P<=42){const s=k[P];s&&C[s]&&C[s].push(r)}}),m.sort((g,E)=>g.id-E.id),R.sort((g,E)=>g.id-E.id),Object.keys(C).forEach(g=>{C[g].sort((E,P)=>E.id-P.id)}),{craftingJobs:m,gatheringJobs:R,battleJobsByRole:C}},[]),fr=new Set([1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111]),gr=new Set([12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,99]),hr={19:[2],20:[1],21:[3],22:[5],23:[4],24:[8,9],25:[6,7],27:[10],28:[10,98],30:[84],31:[88],32:[2,87],33:[89],34:[96],35:[97],36:[105],37:[106],38:[107],39:[108],40:[109],41:[110],42:[111]},mr={8:12,9:14,10:16,11:18,12:20,13:22,14:24,15:26},pr={8:13,9:15,10:17,11:19,12:21,13:23,14:25,15:27},xr={19:11},br={16:28,17:30,18:32},wr={16:29,17:31,18:99},$t={主武器:[1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111,12,14,16,18,20,22,24,26,28,30,32],副手武器:[11,13,15,17,19,21,23,25,27,29,31,33,99]},Bt=new Set([34,35,36,37,38,40,41,42,43,62]),Ze=a.useMemo(()=>{const e=Object.entries(qr).map(([r,s])=>({id:parseInt(r,10),name:s.tw})).filter(r=>!fr.has(r.id)&&!gr.has(r.id)&&!vt.includes(r.id)),n=e.filter(r=>Bt.has(r.id)),k=e.filter(r=>!Bt.has(r.id)&&r.id!==11),m=[34,35,37,36,38,41,40,42,43,62];n.sort((r,s)=>{const l=m.indexOf(r.id),x=m.indexOf(s.id);return l!==-1&&x!==-1?l-x:l!==-1?-1:x!==-1?1:r.id-s.id}),k.sort((r,s)=>r.id===39?1:s.id===39?-1:r.id-s.id);const R=[{id:"main_weapon",name:"主手",isGeneric:!0},{id:"offhand_weapon",name:"副手",isGeneric:!0}],C=[34,35,37,36,38],g=[41,40,42,43],E=n.filter(r=>C.includes(r.id)),P=n.filter(r=>g.includes(r.id)),d=n.filter(r=>!C.includes(r.id)&&!g.includes(r.id));return{weapons:R,armor:E,accessories:P,otherEquipment:d,miscellaneous:k}},[]),Be=a.useCallback(e=>{qt(n=>n.includes(e)?n.filter(k=>k!==e):[...n,e])},[]),St=a.useCallback(e=>{Rt(n=>n.includes(e)?n.filter(k=>k!==e):[...n,e])},[]),Pe=a.useCallback(e=>{Ne(e)},[]),_t=a.useCallback(async(e=!1)=>{if(T.length===0&&te.length===0)return Q("請至少選擇一個職業或分類","warning"),null;if(!O||!H)return Q("請選擇伺服器","warning"),null;let n=new Set;const k=T.filter(d=>d>=8&&d<=18),m=T.filter(d=>d>=1&&d<=7||d>=19&&d<=42);if(k.length>0){const{recipes:d}=await Ft();k.forEach(l=>{d.forEach(x=>{x.job===l&&x.result&&n.add(x.result)})});const r=await at(),s=k.map(l=>It(l)).filter(l=>l);Object.entries(r).forEach(([l,x])=>{x.jobs&&Array.isArray(x.jobs)&&s.some(A=>x.jobs.includes(A))&&n.add(parseInt(l,10))})}if(m.length>0){const d=await at(),r=m.map(s=>It(s)).filter(s=>s);Object.entries(d).forEach(([s,l])=>{l.jobs&&Array.isArray(l.jobs)&&r.some(L=>l.jobs.includes(L))&&n.add(parseInt(s,10))})}if(te.length>0){const d=await At();let r=new Set;if(te.forEach(s=>{s==="main_weapon"?T.length>0?T.forEach(l=>{const x=hr[l];x&&x.forEach(re=>r.add(re));const L=mr[l];L&&r.add(L);const A=br[l];A&&r.add(A)}):$t.主武器.forEach(l=>r.add(l)):s==="offhand_weapon"?T.length>0?T.forEach(l=>{const x=xr[l];x&&r.add(x);const L=pr[l];L&&r.add(L);const A=wr[l];A&&r.add(A)}):$t.副手武器.forEach(l=>r.add(l)):r.add(parseInt(s,10))}),n.size===0&&T.length===0&&Object.keys(ut).forEach(s=>{n.add(parseInt(s,10))}),r.size>0){const s=new Set;n.forEach(l=>{const x=d[l.toString()];vt.includes(x)||x&&r.has(x)&&s.add(l)}),n=s}else{const s=new Set;n.forEach(l=>{const x=d[l.toString()];vt.includes(x)||s.add(l)}),n=s}}if(me>1||pe<999){const d=await at(),r=new Set;n.forEach(s=>{const l=d[s.toString()];!l||l.level===void 0||l.level===null?me===1&&pe===999&&r.add(s):l.level>=me&&l.level<=pe&&r.add(s)}),n=r}if(ze.trim()){const d=new Set,r=ze.trim().split(/\s+/).filter(l=>l),s=(l,x)=>{const L=Array.from(l.toLowerCase()),A=Array.from(x.toLowerCase());if(x.toLowerCase().includes(l.toLowerCase()))return!0;let re=0,fe=0,ae=0,xe=0;for(let c=0;c<L.length;c++){const w=L[c];let N=!1;for(let j=fe;j<A.length;j++)if(A[j]===w){re++,N=!0,j===fe?(ae++,xe=Math.max(xe,ae)):ae=1,fe=j+1;break}if(!N){for(let j=0;j<A.length;j++)if(A[j]===w){re++,N=!0,ae=1,fe=j+1;break}}N||(ae=0)}const y=re/L.length,i=xe/L.length*.3;return y*.7+i>=.6};n.forEach(l=>{const x=ut?.[l.toString()];if(x&&x.tw){const L=x.tw;let A=!1;if(Se)A=r.every(re=>s(re,L));else{const re=L.toLowerCase(),fe=ze.trim().toLowerCase();A=re===fe}A&&d.add(l)}}),n=d}if(n.size===0)return Q("未找到符合條件的物品","warning"),null;const R=await Nt();bt(R);const C=Array.from(n);let g=C.filter(d=>R.has(d));const E=C.filter(d=>!R.has(d));if(g.length===0&&E.length===0)return Q("未找到符合條件的物品","warning"),null;g.length===0&&E.length>0&&de(!0);const P=await nt();return g=g.sort((d,r)=>{const s=P[d?.toString()]||null,l=P[r?.toString()]||null;return s!==null&&l!==null?l-s:s!==null?-1:l!==null?1:r-d}),!e&&g.length>et?(Me({total:g.length,limit:et}),null):{itemIds:n,tradeableItemIds:g,untradeableItemIds:E}},[T,te,O,H,me,pe,ze,Se,Q,Ft,at,At,nt,It]),Tt=a.useCallback(async()=>{if(Me(null),Ge)return;const e=++f.current;G.current&&(G.current.abort(),G.current=null),U.current++,je.current=!1,Ce(!1),X(!1),ee([]),Z([]),de(!1),ke({}),qe({}),Re({}),Ee({}),ge({}),yt([]),tt(!0),setTimeout(()=>{tt(!1)},1500);try{if(V(!0),e!==f.current){V(!1);return}const n=await _t();if(e!==f.current){V(!1);return}if(!n){V(!1);return}const{tradeableItemIds:k,untradeableItemIds:m}=n;if(e!==f.current){V(!1);return}Me(null);const R=await Nt();if(e!==f.current){V(!1);return}bt(R);const C=k.filter(P=>R.has(P)),g=await nt();if(e!==f.current){V(!1);return}const E=async(P,d)=>{if(e!==f.current)return;const r=g,l=[...d?P.filter(y=>R.has(y)):P].sort((y,i)=>{const o=r[y?.toString()]||null,c=r[i?.toString()]||null;return o!==null&&c!==null?c-o:o!==null?-1:c!==null?1:i-y}),x=20,L=l.slice(0,x),A=d?L.filter(y=>R.has(y)):L,fe=A.map(y=>{const o=ut[y?.toString()]?.tw||`物品 (ID: ${y})`;return{id:y,name:o,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((y,i)=>{const o=r[y.id?.toString()]||null,c=r[i.id?.toString()]||null;return o!==null&&c!==null?c-o:o!==null?-1:c!==null?1:i.id-y.id});if(d)ee([]),Z([]),de(!1),He.flushSync(()=>{ee(fe)}),(async()=>{const y=A.map(w=>We(w)),i=(await Promise.all(y)).filter(w=>w!==null);if(e!==f.current)return;const c=i.filter(w=>R.has(w.id)).sort((w,N)=>{const j=r[w.id?.toString()]||null,h=r[N.id?.toString()]||null;return j!==null&&h!==null?h-j:j!==null?-1:h!==null?1:N.id-w.id});e===f.current&&ee(c)})().catch(y=>{console.error("Error loading initial item details:",y)});else{if(C.length>0)return;Z(fe),(async()=>{const y=L.map(c=>We(c)),i=(await Promise.all(y)).filter(c=>c!==null);if(e!==f.current)return;const o=i.sort((c,w)=>{const N=r[c.id?.toString()]||null,j=r[w.id?.toString()]||null;return N!==null&&j!==null?j-N:N!==null?-1:j!==null?1:w.id-c.id});e===f.current&&(C.length>0||Z(o))})().catch(y=>{console.error("Error loading untradeable item details:",y)})}if(O&&H&&l.length>0&&d){if(e!==f.current)return;G.current&&G.current.abort();const y=++U.current;G.current=new AbortController;const i=G.current.signal;je.current=!0,Ce(!0),X(!0),(async()=>{const o=H===O.section,c=o?O.section:H,w=(h,u,I)=>{const p=h?.world?.[I],S=u?.world?.[I],q=h?.dc?.[I],M=u?.dc?.[I],$=o?q!==void 0?q:p:p!==void 0?p:void 0,B=o?M!==void 0?M:S:S!==void 0?S:void 0;if(I==="quantity"){if($!==void 0||B!==void 0)return($||0)+(B||0)}else{if($!==void 0&&B!==void 0)return Math.min($,B);if(B!==void 0)return B;if($!==void 0)return $}return null},N=async(h,u)=>{if(i.aborted||y!==U.current||e!==f.current)return;let I;h===0?I=20:h===1?I=50:I=100;const p=l.slice(u,u+I);if(p.length===0)return;const S=p.join(",");try{const q=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(c)}/${S}`,{signal:i});if(i.aborted||y!==U.current||e!==f.current)return;const M=await q.json();if(M&&M.results){const $={},B={},le={},Xe={},_e={};M.results.forEach(v=>{const b=v.itemId,be=w(v.nq?.dailySaleVelocity,v.hq?.dailySaleVelocity,"quantity");let oe=null;if(o)oe=w(v.nq?.averageSalePrice,v.hq?.averageSalePrice,"price");else{const W=v.nq?.averageSalePrice?.world?.price,F=v.hq?.averageSalePrice?.world?.price,_=v.nq?.averageSalePrice?.dc?.price,z=v.hq?.averageSalePrice?.dc?.price,ie=W!==void 0?W:_,ve=F!==void 0?F:z;ie!==void 0&&ve!==void 0?oe=Math.min(ie,ve):ve!==void 0?oe=ve:ie!==void 0&&(oe=ie)}const se=w(v.nq?.minListing,v.hq?.minListing,"price"),we=w(v.nq?.recentPurchase,v.hq?.recentPurchase,"price");let ce=null;if(se!=null)if(o)ce=se;else{const W=v.nq?.minListing?.world?.price,F=v.hq?.minListing?.world?.price;let _=null;if(W!==void 0&&F!==void 0?_=F<=W?v.hq?.minListing?.world:v.nq?.minListing?.world:F!==void 0?_=v.hq?.minListing?.world:W!==void 0&&(_=v.nq?.minListing?.world),_!==null){const z=_?.region;ce={price:se},z!==void 0&&(ce.region=z)}}let ne=null;if(we!=null)if(o)ne=we;else{const W=v.nq?.recentPurchase?.world?.price,F=v.hq?.recentPurchase?.world?.price;let _=null;W!==void 0&&F!==void 0?_=F<=W?v.hq?.recentPurchase?.world:v.nq?.recentPurchase?.world:F!==void 0?_=v.hq?.recentPurchase?.world:W!==void 0&&(_=v.nq?.recentPurchase?.world);const z=_?.region;ne={price:we},z!==void 0&&(ne.region=z)}be!=null&&($[b]=be),oe!=null&&(B[b]=Math.round(oe)),ce!=null&&(le[b]=ce),ne!=null&&(Xe[b]=ne),_e[b]=!0}),p.forEach(v=>{_e.hasOwnProperty(v)||(_e[v]=!1)}),!i.aborted&&y===U.current&&e===f.current&&(He.flushSync(()=>{ke(v=>({...v,...$})),qe(v=>({...v,...B})),Re(v=>({...v,...le})),Ee(v=>({...v,...Xe})),ge(v=>({...v,..._e}))}),h===0&&X(!1))}}catch(q){if(q.name==="AbortError"||i.aborted)return;console.error("Error fetching market data:",q);const M={};p.forEach($=>{M[$]=!1}),!i.aborted&&y===U.current&&e===f.current&&He.flushSync(()=>{ge($=>({...$,...M}))})}},j=async(h,u)=>{if(i.aborted||y!==U.current||e!==f.current)return;if(u>=l.length){y===U.current&&e===f.current&&!i.aborted&&(X(!1),je.current=!1,Ce(!1));return}if(await N(h,u),i.aborted||y!==U.current||e!==f.current)return;let I;h===0?I=20:h===1?I=50:I=100;const p=u+I;p<l.length?await new Promise(S=>{setTimeout(()=>{j(h+1,p).then(S)},h===0?0:100)}):y===U.current&&e===f.current&&!i.aborted&&(X(!1),je.current=!1,Ce(!1))};try{await j(0,0)}catch(h){h.name!=="AbortError"&&console.error("Error in market data fetch:",h)}})().catch(o=>{o.name!=="AbortError"&&console.error("Error in market data fetch:",o)})}const ae=50,xe=async y=>{if(e!==f.current)return;const i=x+y*ae;if(i>=l.length)return;const o=l.slice(i,i+ae);if(o.length===0)return;const c=o.map(h=>We(h)),w=(await Promise.all(c)).filter(h=>h!==null);if(e!==f.current)return;const j=(d?w.filter(h=>R.has(h.id)):w).sort((h,u)=>{const I=g[h.id?.toString()]||null,p=g[u.id?.toString()]||null;return I!==null&&p!==null?p-I:I!==null?-1:p!==null?1:u.id-h.id});if(e===f.current){if(d)ee(h=>[...h,...j].sort((I,p)=>{const S=g[I.id?.toString()]||null,q=g[p.id?.toString()]||null;return S!==null&&q!==null?q-S:S!==null?-1:q!==null?1:p.id-I.id}));else{if(C.length>0)return;Z(h=>[...h,...j].sort((I,p)=>{const S=g[I.id?.toString()]||null,q=g[p.id?.toString()]||null;return S!==null&&q!==null?q-S:S!==null?-1:q!==null?1:p.id-I.id}))}await new Promise(h=>{setTimeout(()=>{xe(y+1).then(h)},50)})}};l.length>x&&xe(0).catch(y=>{console.error("Error loading remaining batches:",y)})};if(C.length>0?(Z([]),de(!1),E(C,!0).catch(P=>{console.error("Error loading tradeable items progressively:",P)})):m.length>0&&E(m,!1).catch(P=>{console.error("Error loading untradeable items:",P)}),e!==f.current){V(!1);return}(C.length>0||m.length>0)&&Q(`找到 ${C.length} 個可交易物品${m.length>0?`、${m.length} 個不可交易物品`:""}`,"success"),V(!1)}catch(n){if(e!==f.current)return;console.error("Filter search error:",n),Q("搜索失敗，請稍後再試","error"),X(!1),V(!1)}},[T,te,O,H,Q,J,K,ze,me,pe,Se,Ge]);return t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 via-purple-950/30 to-slate-950 text-white",children:[t.jsx(vr,{onSearch:Wt,isSearching:K,searchText:Ot,setSearchText:Ye,isServerDataLoaded:Oe,selectedDcName:O?.section,onItemSelect:ft,showNavigationButtons:!0,activePage:"advanced-search",onAdvancedSearchClick:()=>{Ye(""),gt("/advanced-search")},onMSQPriceCheckerClick:()=>{Ye(""),gt("/msq-price-checker")},onUltimatePriceKingClick:()=>{Ye(""),gt("/ultimate-price-king")}}),t.jsx("div",{className:"fixed right-2 mid:right-4 left-2 mid:left-auto z-50 space-y-2 max-w-sm mid:max-w-none top-[60px] mid:top-4",children:Ut.map(e=>t.jsx(yr,{message:e.message,type:e.type,onClose:()=>Vt(e.id)},e.id))}),t.jsx("div",{className:"pt-24 pb-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-ffxiv-gold mb-2",children:"進階搜尋"}),t.jsx("p",{className:"text-gray-400 text-sm sm:text-base",children:"批量搜尋多個物品的市場價格，或使用篩選條件進行搜尋。"})]}),t.jsxs("div",{className:"mb-6 flex gap-2 border-b border-purple-500/30",children:[t.jsx("button",{onClick:()=>{ht("filter"),Qt(""),Me(null),Ve(1),Ue(999),wt(""),de(!1),ee([]),Z([]),ke({}),qe({}),Re({}),Ee({}),ge({}),Ne(1),G.current&&G.current.abort(),X(!1)},className:`px-4 py-2 font-semibold transition-all border-b-2 ${Y==="filter"?"text-ffxiv-gold border-ffxiv-gold":"text-gray-400 border-transparent hover:text-gray-300"}`,children:"篩選搜尋"}),t.jsx("div",{className:"relative",title:"敬请期待",children:t.jsx("button",{onClick:()=>{},disabled:mt,className:"px-4 py-2 font-semibold transition-all border-b-2 text-gray-500 border-transparent cursor-not-allowed opacity-50",children:"批量搜尋（開發中）"})})]}),Y==="batch"&&!mt,Y==="filter"&&t.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4 sm:p-6 mb-6",children:[t.jsx("div",{className:"bg-slate-700/80 border border-slate-500/50 rounded-lg p-4 mb-6",children:t.jsx("p",{className:"text-sm text-gray-200 leading-relaxed",children:"這個頁面測試量過於龐大，作者個人時間有限。各位使用大大有發現bug歡迎參考主頁上的巴哈或dc方式回報，感激感激"})}),t.jsxs("div",{className:"mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6 items-stretch",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇職業"}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex flex-wrap gap-2",children:[ue.tank.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)}),ue.tank.length>0&&ue.healer.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ue.healer.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)})]}),t.jsxs("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-purple-500/10",children:[ue.melee.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)}),ue.melee.length>0&&ue.ranged.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ue.ranged.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-2 border-t border-purple-500/10",children:[ue.caster.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:ue.caster.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)})}),t.jsx("div",{className:"flex flex-wrap gap-2",children:ur.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)})})]}),t.jsx("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-purple-500/20",children:dr.map(e=>{const n=T.includes(e.id);return t.jsx("button",{onClick:()=>Be(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${n?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,children:Le.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>Ae(e.id)})},e.id)})})]}),T.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",T.length," 個職業"]})]}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇物品分類"}),t.jsx("div",{className:"border border-purple-500/30 rounded-lg p-3 bg-slate-900/30 h-[300px] overflow-y-auto",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-ffxiv-gold mb-2 px-1",children:"裝備類"}),t.jsx("div",{className:"grid grid-cols-4 gap-2 mb-2",children:[...Ze.weapons,...Ze.armor,...Ze.otherEquipment].map(e=>{const n=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(m=>(typeof m=="string"?m:m.toString())===n);return t.jsx("button",{onClick:()=>St(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})}),t.jsx("div",{className:"grid grid-cols-4 gap-2",children:Ze.accessories.map(e=>{const n=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(m=>(typeof m=="string"?m:m.toString())===n);return t.jsx("button",{onClick:()=>St(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),t.jsx("div",{className:"border-t border-purple-500/30 my-2"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-400 mb-2 px-1",children:"雜物類"}),t.jsx("div",{className:"grid grid-cols-4 gap-2",children:Ze.miscellaneous.map(e=>{const n=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(m=>(typeof m=="string"?m:m.toString())===n);return t.jsx("button",{onClick:()=>St(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]})]})}),te.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",te.length," 個分類"]}),t.jsx("div",{className:"mt-2 text-xs text-yellow-400"})]})]}),O&&t.jsxs("div",{className:"mb-6 flex flex-col lg:flex-row lg:justify-between gap-8 lg:gap-10",children:[t.jsxs("div",{className:"flex-shrink-0",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"裝備等級範圍"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{type:"number",min:"1",max:"999",value:lr&&me===1?"":me,onChange:e=>{const n=e.target.value;if(n===""){Ve(1);return}const k=parseInt(n);if(!isNaN(k)){const m=Math.max(1,Math.min(999,k));Ve(m),m>pe&&Ue(m)}},onFocus:()=>{Et(!0)},onBlur:e=>{Et(!1),(e.target.value===""||e.target.value==="1")&&Ve(1)},disabled:he||J,placeholder:"1",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"}),t.jsx("div",{className:"text-gray-400",children:"~"}),t.jsx("input",{type:"number",min:"1",max:"999",value:sr&&pe===999?"":pe,onChange:e=>{const n=e.target.value;if(n===""){Ue(999);return}const k=parseInt(n);if(!isNaN(k)){const m=Math.max(1,Math.min(999,k));Ue(m),m<me&&Ve(m)}},onFocus:()=>{Mt(!0)},onBlur:e=>{Mt(!1),(e.target.value===""||e.target.value==="999")&&Ue(999)},disabled:he||J,placeholder:"999",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"})]})]}),t.jsxs("div",{className:"w-full lg:w-auto lg:ml-auto",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"伺服器選擇"}),t.jsx(Ir,{datacenters:zt,worlds:jt,selectedWorld:O,onWorldChange:Jt,selectedServerOption:H,onServerOptionChange:Gt,serverOptions:Ht,disabled:he||J})]})]}),Fe&&t.jsx("div",{className:"mb-4 p-4 bg-yellow-900/40 border-2 border-yellow-500/50 rounded-lg",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"text-2xl",children:"⚠️"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-yellow-400 font-semibold mb-2",children:"找到的物品過多"}),t.jsxs("p",{className:"text-sm text-gray-300 mb-3",children:["找到 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Fe.total})," 個可交易物品， 超過建議上限 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Fe.limit})," 個。 處理過多物品可能會導致搜索時間過長或性能問題。"]}),t.jsxs("div",{className:"flex gap-2 flex-wrap",children:[t.jsx("button",{onClick:async()=>{if(Ge)return;const e=++f.current;G.current&&(G.current.abort(),G.current=null),U.current++,je.current=!1,Ce(!1),X(!1),Me(null),V(!0),ee([]),Z([]),de(!1),ke({}),qe({}),Re({}),Ee({}),ge({}),yt([]),tt(!0),setTimeout(()=>{tt(!1)},1500);try{const n=await _t(!0);if(e!==f.current){V(!1);return}if(!n){V(!1);return}let{tradeableItemIds:k,untradeableItemIds:m}=n;if(e!==f.current){V(!1);return}const R=await Nt();if(e!==f.current){V(!1);return}bt(R);const g=k.filter(d=>R.has(d)).slice(0,et);Q(`已限制為前 ${g.length} 個物品，正在獲取市場數據...`,"warning");const E=await nt();if(e!==f.current){V(!1);return}const P=async(d,r)=>{if(e!==f.current)return;const s=E,x=[...r?d.filter(i=>R.has(i)):d].sort((i,o)=>{const c=s[i?.toString()]||null,w=s[o?.toString()]||null;return c!==null&&w!==null?w-c:c!==null?-1:w!==null?1:o-i}),L=20,A=x.slice(0,L),re=r?A.filter(i=>R.has(i)):A,ae=re.map(i=>{const c=ut[i?.toString()]?.tw||`物品 (ID: ${i})`;return{id:i,name:c,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((i,o)=>{const c=s[i.id?.toString()]||null,w=s[o.id?.toString()]||null;return c!==null&&w!==null?w-c:c!==null?-1:w!==null?1:o.id-i.id});if(r)ee([]),Z([]),de(!1),He.flushSync(()=>{ee(ae)}),(async()=>{const i=re.map(N=>We(N)),o=(await Promise.all(i)).filter(N=>N!==null);if(e!==f.current)return;const w=o.filter(N=>R.has(N.id)).sort((N,j)=>{const h=s[N.id?.toString()]||null,u=s[j.id?.toString()]||null;return h!==null&&u!==null?u-h:h!==null?-1:u!==null?1:j.id-N.id});e===f.current&&ee(w)})().catch(i=>{console.error("Error loading initial item details:",i)});else{if(g.length>0)return;Z(ae),(async()=>{const i=A.map(w=>We(w)),o=(await Promise.all(i)).filter(w=>w!==null);if(e!==f.current)return;const c=o.sort((w,N)=>{const j=s[w.id?.toString()]||null,h=s[N.id?.toString()]||null;return j!==null&&h!==null?h-j:j!==null?-1:h!==null?1:N.id-w.id});e===f.current&&(g.length>0||Z(c))})().catch(i=>{console.error("Error loading untradeable item details:",i)})}if(O&&H&&x.length>0&&r){G.current&&G.current.abort();const i=++U.current;G.current=new AbortController;const o=G.current.signal;je.current=!0,Ce(!0),X(!0),(async()=>{const c=H===O.section,w=c?O.section:H,N=(u,I,p)=>{const S=u?.world?.[p],q=I?.world?.[p],M=u?.dc?.[p],$=I?.dc?.[p],B=c?M!==void 0?M:S:S!==void 0?S:void 0,le=c?$!==void 0?$:q:q!==void 0?q:void 0;if(p==="quantity"){if(B!==void 0||le!==void 0)return(B||0)+(le||0)}else{if(B!==void 0&&le!==void 0)return Math.min(B,le);if(le!==void 0)return le;if(B!==void 0)return B}return null},j=async(u,I)=>{if(o.aborted||i!==U.current||e!==f.current)return;let p;u===0?p=20:u===1?p=50:p=100;const S=x.slice(I,I+p);if(S.length===0)return;const q=S.join(",");try{const M=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(w)}/${q}`,{signal:o});if(o.aborted||i!==U.current||e!==f.current)return;const $=await M.json();if($&&$.results){const B={},le={},Xe={},_e={},v={};$.results.forEach(b=>{const be=b.itemId,oe=N(b.nq?.dailySaleVelocity,b.hq?.dailySaleVelocity,"quantity");let se=null;if(c)se=N(b.nq?.averageSalePrice,b.hq?.averageSalePrice,"price");else{const F=b.nq?.averageSalePrice?.world?.price,_=b.hq?.averageSalePrice?.world?.price,z=b.nq?.averageSalePrice?.dc?.price,ie=b.hq?.averageSalePrice?.dc?.price,ve=F!==void 0?F:z,ct=_!==void 0?_:ie;ve!==void 0&&ct!==void 0?se=Math.min(ve,ct):ct!==void 0?se=ct:ve!==void 0&&(se=ve)}const we=N(b.nq?.minListing,b.hq?.minListing,"price"),ce=N(b.nq?.recentPurchase,b.hq?.recentPurchase,"price");let ne=null;if(we!=null)if(c)ne=we;else{const F=b.nq?.minListing?.world?.price,_=b.hq?.minListing?.world?.price;let z=null;if(F!==void 0&&_!==void 0?z=_<=F?b.hq?.minListing?.world:b.nq?.minListing?.world:_!==void 0?z=b.hq?.minListing?.world:F!==void 0&&(z=b.nq?.minListing?.world),z!==null){const ie=z?.region;ne={price:we},ie!==void 0&&(ne.region=ie)}}let W=null;if(ce!=null)if(c)W=ce;else{const F=b.nq?.recentPurchase?.world?.price,_=b.hq?.recentPurchase?.world?.price;let z=null;F!==void 0&&_!==void 0?z=_<=F?b.hq?.recentPurchase?.world:b.nq?.recentPurchase?.world:_!==void 0?z=b.hq?.recentPurchase?.world:F!==void 0&&(z=b.nq?.recentPurchase?.world);const ie=z?.region;W={price:ce},ie!==void 0&&(W.region=ie)}oe!=null&&(B[be]=oe),se!=null&&(le[be]=Math.round(se)),ne!=null&&(Xe[be]=ne),W!=null&&(_e[be]=W),v[be]=!0}),S.forEach(b=>{v.hasOwnProperty(b)||(v[b]=!1)}),!o.aborted&&i===U.current&&e===f.current&&(He.flushSync(()=>{ke(b=>({...b,...B})),qe(b=>({...b,...le})),Re(b=>({...b,...Xe})),Ee(b=>({...b,..._e})),ge(b=>({...b,...v}))}),u===0&&X(!1))}}catch(M){if(M.name==="AbortError"||o.aborted)return;console.error("Error fetching market data:",M);const $={};S.forEach(B=>{$[B]=!1}),!o.aborted&&i===U.current&&e===f.current&&He.flushSync(()=>{ge(B=>({...B,...$}))})}},h=async(u,I)=>{if(o.aborted||i!==U.current||e!==f.current)return;if(I>=x.length){i===U.current&&e===f.current&&!o.aborted&&(X(!1),je.current=!1,Ce(!1));return}if(await j(u,I),o.aborted||i!==U.current||e!==f.current)return;let p;u===0?p=20:u===1?p=50:p=100;const S=I+p;S<x.length?await new Promise(q=>{setTimeout(()=>{h(u+1,S).then(q)},u===0?0:100)}):i===U.current&&e===f.current&&!o.aborted&&(X(!1),je.current=!1,Ce(!1))};try{await h(0,0)}catch(u){u.name!=="AbortError"&&console.error("Error in market data fetch:",u)}})().catch(c=>{c.name!=="AbortError"&&console.error("Error in market data fetch:",c)})}const xe=50,y=async i=>{if(e!==f.current)return;const o=L+i*xe;if(o>=x.length)return;const c=x.slice(o,o+xe);if(c.length===0)return;const w=c.map(u=>We(u)),N=(await Promise.all(w)).filter(u=>u!==null);if(e!==f.current)return;const h=(r?N.filter(u=>R.has(u.id)):N).sort((u,I)=>{const p=E[u.id?.toString()]||null,S=E[I.id?.toString()]||null;return p!==null&&S!==null?S-p:p!==null?-1:S!==null?1:I.id-u.id});if(e===f.current){if(r)ee(u=>[...u,...h].sort((p,S)=>{const q=E[p.id?.toString()]||null,M=E[S.id?.toString()]||null;return q!==null&&M!==null?M-q:q!==null?-1:M!==null?1:S.id-p.id}));else{if(g.length>0)return;Z(u=>[...u,...h].sort((p,S)=>{const q=E[p.id?.toString()]||null,M=E[S.id?.toString()]||null;return q!==null&&M!==null?M-q:q!==null?-1:M!==null?1:S.id-p.id}))}await new Promise(u=>{setTimeout(()=>{y(i+1).then(u)},50)})}};x.length>L&&y(0).catch(i=>{console.error("Error loading remaining batches:",i)})};if(g.length>0?(Z([]),de(!1),P(g,!0).catch(d=>{console.error("Error loading tradeable items progressively:",d)})):m.length>0&&P(m,!1).catch(d=>{console.error("Error loading untradeable items:",d)}),e!==f.current){V(!1);return}(g.length>0||m.length>0)&&Q(`找到 ${g.length} 個可交易物品${m.length>0?`、${m.length} 個不可交易物品`:""}`,"success"),V(!1)}catch(n){if(e!==f.current)return;console.error("Continue search error:",n),Q("搜索失敗，請稍後再試","error"),X(!1),V(!1)}},className:"confirm-button-attention py-3",children:t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx("span",{children:"確認"}),t.jsxs("span",{children:["繼續搜索（限制為前 ",et," 個）"]})]})}),t.jsx("button",{onClick:()=>Me(null),className:"px-4 py-2 bg-slate-700/50 border border-gray-500/50 rounded-lg text-gray-300 hover:bg-slate-700/70 transition-all text-sm font-medium",children:"取消"})]})]})]})}),t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("div",{className:"w-[40%] relative",children:[t.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{type:"text",value:ze,onChange:e=>wt(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!J&&!K&&(T.length>0||te.length>0)&&!Fe&&Tt()},placeholder:"物品名篩選（多關鍵詞用空格分隔）",disabled:J||K,className:`w-full py-3 pl-10 pr-20 rounded-lg bg-slate-900/90 backdrop-blur-sm border text-white placeholder-gray-400 focus:outline-none focus:ring-1 transition-all text-sm shadow-lg ${J||K?"border-slate-700/30 cursor-not-allowed opacity-60":"border-purple-500/40 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 shadow-purple-500/20"}`}),t.jsxs("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-10 flex items-center gap-1.5",children:[t.jsxs("label",{className:"flex items-center cursor-pointer group",title:Se?"開啟精準搜尋":"關閉精準搜尋",children:[t.jsx("input",{type:"checkbox",checked:!Se,onChange:e=>ir(!e.target.checked),disabled:J||K,className:"sr-only"}),t.jsx("div",{className:`relative w-9 h-5 rounded-full transition-colors duration-200 ${J||K?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${Se?"bg-slate-600/60":"bg-ffxiv-gold/80"}`,children:t.jsx("div",{className:`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-200 ${Se?"translate-x-0":"translate-x-4"}`})})]}),t.jsx("span",{className:`text-xs whitespace-nowrap select-none ${J||K?"text-gray-500":Se?"text-gray-400":"text-ffxiv-gold"}`,children:"精準"})]})]}),t.jsx("button",{onClick:Tt,disabled:J||K||Ge||T.length===0&&te.length===0||Fe!==null,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${J||K||Ge||T.length===0&&te.length===0||Fe!==null?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-gradient-to-r from-ffxiv-gold to-yellow-500 text-slate-900 hover:shadow-[0_0_20px_rgba(212,175,55,0.5)]"}`,children:J||K?"搜索中...":"搜索"}),t.jsx("button",{onClick:()=>{qt([]),Rt([]),Ve(1),Ue(999),wt(""),ee([]),Z([]),de(!1),ke({}),qe({}),Re({}),Ee({}),ge({}),Ne(1),Me(null),G.current&&G.current.abort(),X(!1),V(!1)},disabled:J||K,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${J||K?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-red-600/60 text-white border border-red-500/50 hover:bg-red-600/80 hover:border-red-400/70 hover:shadow-[0_0_20px_rgba(220,38,38,0.5)]"}`,children:"清空篩選"})]})]}),(()=>{const e=ye.length>0;if(!(Y==="filter"?e||!e&&Ie.length>0:Y==="batch"&&!mt))return null;const m=Y==="filter"?Te&&!e?Ie:ye:[],R=(()=>{if(!$e)return{};const r={};return m.forEach(s=>{const l=$e[s.id?.toString()]!==void 0?$e[s.id.toString()]:0;r[l]=(r[l]||0)+1}),r})();let C=m;if(st.length>0&&$e){const r=st[0];C=C.filter(s=>($e[s.id?.toString()]!==void 0?$e[s.id.toString()]:0)===r)}const g=Math.ceil(C.length/De),E=(D-1)*De,P=E+De,d=C.slice(E,P);return t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[t.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-ffxiv-gold",children:["搜索結果 (",C.length," 個物品)"]}),O&&H&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-900/40 via-pink-900/30 to-indigo-900/40 border border-purple-500/30 rounded-lg backdrop-blur-sm",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-ffxiv-gold animate-pulse"}),t.jsx("span",{className:"text-xs sm:text-sm font-semibold text-ffxiv-gold",children:H===O.section?`${O.section} (全服)`:jt[H]||`伺服器 ${H}`})]}),Y==="filter"&&Ie.length>0&&t.jsx("button",{onClick:()=>{de(!Te),Ne(1)},disabled:he||J,className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all ${he||J?"bg-slate-800/30 text-gray-500 border border-slate-700/30 cursor-not-allowed opacity-50":Te?"bg-orange-600/40 text-orange-300 border border-orange-500/50 hover:bg-orange-600/60":"bg-slate-800/50 text-gray-300 border border-purple-500/30 hover:bg-purple-800/40 hover:border-purple-400/50"}`,children:Te?`隱藏 (${Ie.length} 個不可交易)`:`顯示 (${Ie.length} 個不可交易)`}),ar&&C.length>=50&&t.jsxs("div",{className:"ml-auto flex items-center gap-2 px-2 py-1 bg-slate-800/50 border border-purple-500/30 rounded-lg",children:[t.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-ffxiv-gold"}),t.jsx("span",{className:"text-xs text-gray-300",children:"載入中"})]})]}),C.length>De&&t.jsxs("div",{className:"mb-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:De,onChange:r=>{const s=parseInt(r.target.value,10);Lt(s),Ne(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",E+1,"-",Math.min(P,C.length)," / ",C.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Pe(1),disabled:D===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Pe(D-1),disabled:D===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",D," / ",g," 頁"]}),t.jsx("button",{onClick:()=>Pe(D+1),disabled:D===g,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===g?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Pe(g),disabled:D===g,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===g?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]}),t.jsx(Sr,{items:d,onSelect:r=>{if(ft){const s=new URLSearchParams;H&&s.set("server",H);const l=s.toString(),x=`/item/${r.id}${l?"?"+l:""}`;ft(r),window.open(x,"_blank")}},selectedItem:null,marketableItems:tr,itemVelocities:Kt,itemAveragePrices:Zt,itemMinListings:Xt,itemRecentPurchases:Yt,itemTradability:er,isLoadingVelocities:he,averagePriceHeader:"平均價格",getSimplifiedChineseName:Pr,addToast:Q,selectedRarities:st,setSelectedRarities:yt,raritiesData:$e,externalRarityFilter:!0,externalRarityCounts:R,isServerDataLoaded:Oe,isRaritySelectorDisabled:!Oe||he||or||kt||J}),C.length>De&&t.jsxs("div",{className:"mt-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:De,onChange:r=>{const s=parseInt(r.target.value,10);Lt(s),Ne(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",E+1,"-",Math.min(P,C.length)," / ",C.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Pe(1),disabled:D===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Pe(D-1),disabled:D===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",D," / ",g," 頁"]}),t.jsx("button",{onClick:()=>Pe(D+1),disabled:D===g,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===g?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Pe(g),disabled:D===g,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${D===g?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]})]})})()]})})]})}export{Fr as default};
